<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Note Taking App</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    <link rel="icon" href="https://cdn.sovereigns.co/favicon.png">
    <style>
:root {
    --bg-dark: #1e1e1e;
    --sidebar-dark: #252526;
    --text-color: #e0e0e0;
    --accent-color: #569cd6;
    --card-bg: #2d2d2d;
    --button-bg: #3c3c3c;
    --button-hover: #4e4e4e;
    --delete-color: #ce4242;
    --delete-hover: #e05050;
}

body {
    font-family: 'Roboto Mono', monospace;
    margin: 0;
    padding: 0;
    background-color: var(--bg-dark);
    color: var(--text-color);
    height: 100vh;
    display: flex;
    overflow: hidden;
}

#sidebar {
    background-color: var(--sidebar-dark);
    width: 250px;
    height: 100vh;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    position: fixed;
    z-index: 10;
    transform: translateX(-250px);
    transition: transform 0.3s ease;
}
#sidebar.visible {
    transform: translateX(0);
}
#toggle-sidebar {
    position: fixed;
    left: 0;
    top: 50%;
    transform: translateY(-50%);
    background: var(--sidebar-dark);
    border: none;
    color: var(--text-color);
    width: 30px;
    height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 20;
    border-radius: 0 4px 4px 0;
    box-shadow: 2px 0 5px rgba(0,0,0,0.2);
}
#toggle-sidebar:hover {
    background-color: var(--button-hover);
}
#sidebar-header {
    padding: 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border-bottom: 1px solid #333;
}
#main-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    height: 100vh;
    overflow-y: auto;
    margin-left: 30px;
    transition: margin-left 0.3s ease;
}
#main-content.sidebar-visible {
    margin-left: 250px;
}
@media screen and (max-width: 768px) {
    body {
        flex-direction: column;
        overflow: auto;
    }
    #sidebar {
        width: 100%;
        height: 100vh;
        position: fixed;
        transform: translateX(-100%);
    }
    #main-content {
        margin-left: 30px;
        height: auto;
        min-height: 60vh;
    }
    #main-content.sidebar-visible {
        margin-left: 30px;
    }
    #toggle-sidebar {
        width: 30px;
        height: 50px;
    }
}

#new-note-btn {
    background-color: var(--accent-color);
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
    margin: 15px;
    font-family: 'Roboto Mono', monospace;
}
#new-note-btn:hover {
    background-color: #4a88c7;
}
.note-card {
    padding: 10px 15px;
    border-bottom: 1px solid #333;
    cursor: pointer;
    transition: background-color 0.2s;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
}
.note-card:hover {
    background-color: #333;
}
.note-card.active {
    background-color: #3a3d41;
    border-left: 3px solid var(--accent-color);
}
.note-content {
    flex: 1;
    overflow: hidden;
}
.note-title {
    font-weight: bold;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
.note-preview {
    color: #a0a0a0;
    font-size: 0.8rem;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}
.delete-btn {
    background-color: transparent;
    color: var(--text-color);
    border: none;
    font-size: 1rem;
    cursor: pointer;
    opacity: 0.5;
    padding: 0 0 0 8px;
    transition: all 0.2s;
}
.delete-btn:hover {
    color: var(--delete-color);
    opacity: 1;
}
#toolbar {
    padding: 10px;
    display: flex;
    gap: 5px;
    border-bottom: 1px solid #333;
}
.tool-btn {
    background: var(--button-bg);
    border: none;
    color: var(--text-color);
    width: 30px;
    height: 30px;
    cursor: pointer;
    border-radius: 4px;
    font-size: 1rem;
}
.tool-btn:hover {
    background-color: var(--button-hover);
}
.dropdown {
    position: relative;
    display: inline-block;
}
.dropdown-content {
    display: none;
    position: absolute;
    background-color: var(--card-bg);
    min-width: 120px;
    box-shadow: 0 8px 16px rgba(0,0,0,0.2);
    z-index: 1;
    border-radius: 4px;
}
.dropdown-content button {
    background: none;
    border: none;
    color: var(--text-color);
    padding: 8px 16px;
    text-align: left;
    width: 100%;
    cursor: pointer;
    font-family: 'Roboto Mono', monospace;
}
.dropdown-content button:hover {
    background-color: var(--button-hover);
}
.dropdown:hover .dropdown-content {
    display: block;
}
#editor-container {
    flex: 1;
    padding: 20px;
    display: flex;
    flex-direction: column;
}
#note-title-input {
    background: transparent;
    border: none;
    border-bottom: 1px solid #444;
    color: var(--text-color);
    font-size: 1.5rem;
    padding: 5px 0;
    margin-bottom: 15px;
    font-family: 'Roboto Mono', monospace;
    width: 100%;
}
#editor {
    flex: 1;
    background: transparent;
    border: none;
    color: var(--text-color);
    font-size: 1rem;
    line-height: 1.5;
    resize: none;
    padding: 10px 0;
    font-family: 'Roboto Mono', monospace;
}
#editor:focus, #note-title-input:focus {
    outline: none;
}
#editor:empty:before {
    content: 'Start typing your note here...';
    color: #666;
}
#welcome-screen {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    height: 100%;
    text-align: center;
    padding: 20px;
}
#footer {
    padding: 10px;
    text-align: right;
    border-top: 1px solid #333;
}
#export-btn, #lock-btn {
    background-color: var(--button-bg);
    color: var(--text-color);
    border: none;
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
    font-family: 'Roboto Mono', monospace;
    margin-left: 10px;
}
#export-btn:hover, #lock-btn:hover {
    background-color: var(--button-hover);
}
#lock-btn {
    background-color: var(--accent-color);
}
#lock-btn:hover {
    background-color: #4a88c7;
}
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7);
    z-index: 100;
    justify-content: center;
    align-items: center;
}
.modal-content {
    background-color: var(--card-bg);
    padding: 20px;
    border-radius: 5px;
    max-width: 400px;
    width: 80%;
}
.modal-title {
    margin-top: 0;
}
.modal-buttons {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    margin-top: 20px;
}
.modal-btn {
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
    font-family: 'Roboto Mono', monospace;
    border: none;
}
.cancel-btn {
    background-color: var(--button-bg);
    color: var(--text-color);
}
.cancel-btn:hover {
    background-color: var(--button-hover);
}
.confirm-btn {
    background-color: var(--delete-color);
    color: white;
}
.confirm-btn:hover {
    background-color: var(--delete-hover);
}
.password-input {
    width: 100%;
    padding: 8px;
    margin-top: 10px;
    background-color: var(--bg-dark);
    border: 1px solid #444;
    border-radius: 4px;
    color: var(--text-color);
    font-family: 'Roboto Mono', monospace;
}
.encryption-status {
    display: flex;
    align-items: center;
    margin-right: auto;
}
.status-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    margin-right: 6px;
}
.status-secured {
    background-color: #4ec9b0;
}
.status-unsecured {
    background-color: #ce9178;
}
.system-message {
    background-color: rgba(0, 0, 0, 0.3);
    padding: 10px;
    margin: 5px 0;
    border-radius: 4px;
    font-size: 0.9rem;
    text-align: center;
}
@media screen and (max-width: 480px) {
    .note-card {
        padding: 8px;
    }
    #note-title-input {
        font-size: 1.2rem;
    }
    .tool-btn {
        width: 36px;
        height: 36px;
    }
    .modal-buttons {
        flex-direction: column;
    }
    .modal-btn {
        width: 100%;
        margin-top: 5px;
    }
    .dropdown-content {
        min-width: 100px;
    }
    .password-input {
        font-size: 16px;
    }
}
    </style>
</head>
<body>
<button id="toggle-sidebar">â˜°</button>

<div id="sidebar">
    <div id="sidebar-header">
        <h2>Notes</h2>
    </div>
    <button id="new-note-btn">+ New Note</button>
    <div id="notes-list"></div>
</div>

<div id="main-content">
    <div id="toolbar">
        <button class="tool-btn" onclick="document.execCommand('bold')">B</button>
        <button class="tool-btn" onclick="document.execCommand('italic')">I</button>
        <button class="tool-btn" onclick="document.execCommand('underline')">U</button>
        <div class="dropdown">
            <button class="tool-btn">A</button>
            <div class="dropdown-content">
                <button onclick="setFontSize('1')">Small</button>
                <button onclick="setFontSize('3')">Normal</button>
                <button onclick="setFontSize('5')">Large</button>
                <button onclick="setFontSize('7')">X-Large</button>
            </div>
        </div>
        <div class="dropdown">
            <button class="tool-btn">ðŸŽ¨</button>
            <div class="dropdown-content">
                <button onclick="setTextColor('#e0e0e0')">White</button>
                <button onclick="setTextColor('#569cd6')">Blue</button>
                <button onclick="setTextColor('#ce9178')">Orange</button>
                <button onclick="setTextColor('#4ec9b0')">Green</button>
            </div>
        </div>
    </div>
    
    <div id="editor-container">
        <input type="text" id="note-title-input" placeholder="Note Title">
        <div id="editor" contenteditable="true"></div>
    </div>
    
    <div id="footer">
        <div class="encryption-status">
            <div id="status-indicator" class="status-indicator status-unsecured"></div>
            <span id="status-text">Unsecured</span>
        </div>
        <button id="lock-btn">ðŸ”’ Set Password</button>
        <button id="export-btn">Export Notes</button>
    </div>
    
    <div id="welcome-screen">
        <h2>Welcome to Secure Notes</h2>
        <p>Create a new note or select an existing one from the sidebar.</p>
        <p>For maximum security, set an encryption password by clicking ðŸ”’ Set Password.</p>
    </div>
</div>

<!-- Delete Modal -->
<div id="delete-modal" class="modal">
    <div class="modal-content">
        <h2 class="modal-title">Confirm Delete</h2>
        <p>Are you sure you want to delete this note? This action cannot be undone.</p>
        <div class="modal-buttons">
            <button id="cancel-delete" class="modal-btn cancel-btn">Cancel</button>
            <button id="confirm-delete" class="modal-btn confirm-btn">Delete</button>
        </div>
    </div>
</div>

<!-- Password Modal -->
<div id="password-modal" class="modal">
    <div class="modal-content">
        <h2 class="modal-title">Set Encryption Password</h2>
        <p>Enter a password to encrypt your notes (minimum 8 characters).</p>
        <input type="password" id="password-input" class="password-input" placeholder="Password">
        <input type="password" id="confirm-password-input" class="password-input" placeholder="Confirm Password">
        <div id="password-message" class="system-message" style="display: none;"></div>
        <div class="modal-buttons">
            <button id="cancel-password" class="modal-btn cancel-btn">Cancel</button>
            <button id="confirm-password" class="modal-btn confirm-btn">Set Password</button>
        </div>
    </div>
</div>

<!-- Unlock Modal -->
<div id="unlock-modal" class="modal">
    <div class="modal-content">
        <h2 class="modal-title">Unlock Notes</h2>
        <p>Enter your password to access your encrypted notes. Note: Password is required per browser session.</p>
        <input type="password" id="unlock-password-input" class="password-input" placeholder="Password">
        <div id="unlock-message" class="system-message" style="display: none;"></div>
        <div class="modal-buttons">
            <button id="unlock-password" class="modal-btn confirm-btn">Unlock</button>
        </div>
    </div>
</div>

<!-- System Message Container -->
<div id="system-message-container" class="system-message" style="display: none;"></div>

<script>
// Crypto utilities
const cryptoUtils = {
    generateSalt: async function() {
        return window.crypto.getRandomValues(new Uint8Array(16));
    },
    str2ab: function(str) {
        const encoder = new TextEncoder();
        return encoder.encode(str);
    },
    ab2hex: function(buffer) {
        return Array.from(new Uint8Array(buffer))
            .map(b => b.toString(16).padStart(2, '0'))
            .join('');
    },
    hex2ab: function(hex) {
        const bytes = new Uint8Array(hex.length / 2);
        for (let i = 0; i < hex.length; i += 2) {
            bytes[i/2] = parseInt(hex.substring(i, i + 2), 16);
        }
        return bytes;
    },
    deriveKey: async function(password, salt) {
        const keyMaterial = await window.crypto.subtle.importKey(
            "raw",
            this.str2ab(password),
            { name: "PBKDF2" },
            false,
            ["deriveBits", "deriveKey"]
        );
        return window.crypto.subtle.deriveKey(
            {
                name: "PBKDF2",
                salt: salt,
                iterations: 100000,
                hash: "SHA-256"
            },
            keyMaterial,
            { name: "AES-GCM", length: 256 },
            false,
            ["encrypt", "decrypt"]
        );
    },
    encrypt: async function(data, password) {
        try {
            const salt = await this.generateSalt();
            const key = await this.deriveKey(password, salt);
            const iv = window.crypto.getRandomValues(new Uint8Array(12));
            const encryptedContent = await window.crypto.subtle.encrypt(
                { name: "AES-GCM", iv: iv },
                key,
                this.str2ab(data)
            );
            return {
                version: 1,
                salt: this.ab2hex(salt),
                iv: this.ab2hex(iv),
                data: this.ab2hex(encryptedContent)
            };
        } catch (e) {
            console.error("Encryption failed:", e);
            throw e;
        }
    },
    decrypt: async function(encryptedData, password) {
        try {
            const { salt, iv, data } = encryptedData;
            const saltBuffer = this.hex2ab(salt);
            const ivBuffer = this.hex2ab(iv);
            const dataBuffer = this.hex2ab(data);
            const key = await this.deriveKey(password, saltBuffer);
            const decryptedContent = await window.crypto.subtle.decrypt(
                { name: "AES-GCM", iv: ivBuffer },
                key,
                dataBuffer
            );
            const decoder = new TextDecoder();
            return decoder.decode(decryptedContent);
        } catch (e) {
            console.error("Decryption failed:", e);
            throw e;
        }
    }
};

// Check Web Crypto API availability
if (!window.crypto || !window.crypto.subtle) {
    showSystemMessage('This application requires a secure context (HTTPS) to function properly.', 'error');
}

// Password utilities
async function storePasswordHash(password) {
    try {
        const encoder = new TextEncoder();
        const data = encoder.encode(password);
        const hashBuffer = await crypto.subtle.digest('SHA-256', data);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        localStorage.setItem('notesMasterPasswordHash', hashHex);
    } catch (e) {
        console.error('Error hashing password:', e);
    }
}

async function verifyPassword(password) {
    try {
        const encoder = new TextEncoder();
        const data = encoder.encode(password);
        const hashBuffer = await crypto.subtle.digest('SHA-256', data);
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        return hashHex === localStorage.getItem('notesMasterPasswordHash');
    } catch (e) {
        console.error('Error verifying password:', e);
        return false;
    }
}

// DOM elements
const sidebar = document.getElementById('sidebar');
const toggleSidebar = document.getElementById('toggle-sidebar');
const newNoteBtn = document.getElementById('new-note-btn');
const notesList = document.getElementById('notes-list');
const noteTitleInput = document.getElementById('note-title-input');
const editor = document.getElementById('editor');
const editorContainer = document.getElementById('editor-container');
const welcomeScreen = document.getElementById('welcome-screen');
const exportBtn = document.getElementById('export-btn');
const lockBtn = document.getElementById('lock-btn');
const deleteModal = document.getElementById('delete-modal');
const cancelDeleteBtn = document.getElementById('cancel-delete');
const confirmDeleteBtn = document.getElementById('confirm-delete');
const passwordModal = document.getElementById('password-modal');
const cancelPasswordBtn = document.getElementById('cancel-password');
const confirmPasswordBtn = document.getElementById('confirm-password');
const passwordInput = document.getElementById('password-input');
const confirmPasswordInput = document.getElementById('confirm-password-input');
const passwordMessage = document.getElementById('password-message');
const unlockModal = document.getElementById('unlock-modal');
const unlockPasswordInput = document.getElementById('unlock-password-input');
const unlockButton = document.getElementById('unlock-password');
const unlockMessage = document.getElementById('unlock-message');
const statusIndicator = document.getElementById('status-indicator');
const statusText = document.getElementById('status-text');
const systemMessageContainer = document.getElementById('system-message-container');

unlockButton.addEventListener('click', unlockNotes);

let currentNoteId = null;
let noteToDeleteId = null;
let notes = [];
let isEncrypted = false;

function init() {
    if (!window.crypto.subtle) {
        showSystemMessage('Encryption is not supported in this environment. Notes will not be secure.', 'error');
        loadNotes();
        setupEventListeners();
        if (notes.length === 0) {
            showWelcomeScreen();
        } else {
            loadNote(notes[0].id);
        }
        return;
    }

    if (localStorage.getItem('notesMasterPasswordHash')) {
        isEncrypted = true;
        updateEncryptionStatus();
        showUnlockModal();
    } else {
        loadNotes();
        setupEventListeners();
        if (notes.length === 0) {
            showWelcomeScreen();
        } else {
            loadNote(notes[0].id);
        }
    }
}

function setupEventListeners() {
    toggleSidebar.addEventListener('click', () => {
        sidebar.classList.toggle('visible');
        document.getElementById('main-content').classList.toggle('sidebar-visible');
        toggleSidebar.innerHTML = sidebar.classList.contains('visible') ? 'Ã—' : 'â˜°';
    });

    newNoteBtn.addEventListener('click', createNewNote);
    noteTitleInput.addEventListener('input', saveCurrentNote);
    editor.addEventListener('input', saveCurrentNote);
    exportBtn.addEventListener('click', exportNotes);
    lockBtn.addEventListener('click', showPasswordModal);

    cancelDeleteBtn.addEventListener('click', () => {
        deleteModal.style.display = 'none';
        noteToDeleteId = null;
    });

    confirmDeleteBtn.addEventListener('click', () => {
        if (noteToDeleteId) {
            deleteNote(noteToDeleteId);
            deleteModal.style.display = 'none';
            noteToDeleteId = null;
        }
    });

    cancelPasswordBtn.addEventListener('click', () => {
        passwordModal.style.display = 'none';
        passwordInput.value = '';
        confirmPasswordInput.value = '';
        passwordMessage.style.display = 'none';
    });

    confirmPasswordBtn.addEventListener('click', setEncryptionPassword);

    window.addEventListener('resize', () => {
        if (window.innerWidth > 768) {
            sidebar.classList.remove('visible');
            document.getElementById('main-content').classList.remove('sidebar-visible');
            toggleSidebar.innerHTML = 'â˜°';
        }
    });

    // Editor placeholder handling
    editor.addEventListener('input', () => {
        if (editor.innerHTML === '') {
            editor.classList.add('empty');
        } else {
            editor.classList.remove('empty');
        }
    });
}

function showSystemMessage(message, type) {
    systemMessageContainer.textContent = message;
    systemMessageContainer.style.display = message ? 'block' : 'none';
    systemMessageContainer.style.color = type === 'error' ? '#ce4242' : '#4ec9b0';
}

function showPasswordModal() {
    passwordModal.style.display = 'flex';
}

function showUnlockModal() {
    unlockModal.style.display = 'flex';
}

async function setEncryptionPassword() {
    const password = passwordInput.value;
    const confirmPassword = confirmPasswordInput.value;

    if (password.length < 8) {
        showPasswordMessage('Password must be at least 8 characters long', 'error');
        return;
    }

    if (password !== confirmPassword) {
        showPasswordMessage('Passwords do not match', 'error');
        return;
    }

    try {
        await storePasswordHash(password);
        sessionStorage.setItem('currentSessionPassword', password);
        await saveNotes();
        isEncrypted = true;
        updateEncryptionStatus();
        passwordModal.style.display = 'none';
        passwordInput.value = '';
        confirmPasswordInput.value = '';
        showPasswordMessage('', 'success');
    } catch (error) {
        console.error('Error setting encryption password:', error);
        showPasswordMessage('Failed to set password. Please try again.', 'error');
    }
}

function showPasswordMessage(message, type) {
    passwordMessage.textContent = message;
    passwordMessage.style.display = message ? 'block' : 'none';
    passwordMessage.style.color = type === 'error' ? '#ce4242' : '#4ec9b0';
}

function showUnlockMessage(message, type) {
    unlockMessage.textContent = message;
    unlockMessage.style.display = message ? 'block' : 'none';
    unlockMessage.style.color = type === 'error' ? '#ce4242' : '#4ec9b0';
}

async function unlockNotes() {
    const password = unlockPasswordInput.value;

    if (!password) {
        showUnlockMessage('Please enter your password', 'error');
        return;
    }

    try {
        const isPasswordValid = await verifyPassword(password);
        if (!isPasswordValid) {
            showUnlockMessage('Incorrect password', 'error');
            return;
        }

        sessionStorage.setItem('currentSessionPassword', password);
        await loadNotes();
        setupEventListeners();
        if (notes.length === 0) {
            showWelcomeScreen();
        } else {
            loadNote(notes[0].id);
        }
        unlockModal.style.display = 'none';
        unlockPasswordInput.value = '';
        showUnlockMessage('', 'success');
    } catch (error) {
        console.error('Error unlocking notes:', error);
        showUnlockMessage('Failed to unlock notes. Please try again.', 'error');
    }
}

function updateEncryptionStatus() {
    if (isEncrypted) {
        statusIndicator.classList.remove('status-unsecured');
        statusIndicator.classList.add('status-secured');
        statusText.textContent = 'Secured';
        lockBtn.textContent = 'ðŸ”’ Change Password';
    } else {
        statusIndicator.classList.remove('status-secured');
        statusIndicator.classList.add('status-unsecured');
        statusText.textContent = 'Unsecured';
        lockBtn.textContent = 'ðŸ”’ Set Password';
    }
}

function createNewNote() {
    const newNote = {
        id: Date.now().toString(),
        title: 'Untitled Note',
        content: '',
        created: new Date().toISOString()
    };
    notes.unshift(newNote);
    saveNotes();
    renderNotesList();
    loadNote(newNote.id);
}

async function loadNotes() {
    const encryptedNotesData = localStorage.getItem('notes');
    if (!encryptedNotesData) {
        notes = [];
        renderNotesList();
        return;
    }

    try {
        if (isEncrypted) {
            const password = sessionStorage.getItem('currentSessionPassword');
            if (!password) {
                throw new Error('No password available to decrypt notes');
            }
            const encryptedData = JSON.parse(encryptedNotesData);
            const decryptedNotes = await cryptoUtils.decrypt(encryptedData, password);
            notes = JSON.parse(decryptedNotes);
        } else {
            try {
                notes = JSON.parse(encryptedNotesData);
            } catch {
                notes = [];
            }
        }
        renderNotesList();
    } catch (e) {
        console.error('Error loading notes:', e);
        showSystemMessage('Error loading notes. Please check your password and try again.', 'error');
        notes = [];
        renderNotesList();
    }
}

async function saveNotes() {
    try {
        if (isEncrypted) {
            const password = sessionStorage.getItem('currentSessionPassword');
            if (!password) {
                throw new Error('No password available to encrypt notes');
            }
            const notesString = JSON.stringify(notes);
            const encryptedData = await cryptoUtils.encrypt(notesString, password);
            localStorage.setItem('notes', JSON.stringify(encryptedData));
        } else {
            localStorage.setItem('notes', JSON.stringify(notes));
        }
    } catch (e) {
        console.error('Error saving notes:', e);
        showSystemMessage('Error saving notes. Please try again.', 'error');
    }
}

function saveCurrentNote() {
    if (!currentNoteId) return;
    const noteIndex = notes.findIndex(note => note.id === currentNoteId);
    if (noteIndex === -1) return;
    notes[noteIndex].title = noteTitleInput.value || 'Untitled Note';
    notes[noteIndex].content = editor.innerHTML;
    notes[noteIndex].updated = new Date().toISOString();
    saveNotes();
    renderNotesList();
}

function loadNote(noteId) {
    const note = notes.find(note => note.id === noteId);
    if (!note) return;
    currentNoteId = noteId;
    noteTitleInput.value = note.title;
    editor.innerHTML = note.content;
    hideWelcomeScreen();
    renderNotesList();
}

function deleteNote(noteId) {
    const noteIndex = notes.findIndex(note => note.id === noteId);
    if (noteIndex === -1) return;
    notes.splice(noteIndex, 1);
    saveNotes();
    renderNotesList();
    if (notes.length === 0) {
        currentNoteId = null;
        showWelcomeScreen();
    } else if (currentNoteId === noteId) {
        loadNote(notes[0].id);
    }
}

function showDeleteModal(noteId) {
    noteToDeleteId = noteId;
    deleteModal.style.display = 'flex';
}

function renderNotesList() {
    notesList.innerHTML = '';
    notes.forEach(note => {
        const noteCard = document.createElement('div');
        noteCard.className = 'note-card';
        noteCard.dataset.id = note.id;
        if (note.id === currentNoteId) {
            noteCard.classList.add('active');
        }
        const noteContent = document.createElement('div');
        noteContent.className = 'note-content';
        const noteTitle = document.createElement('div');
        noteTitle.className = 'note-title';
        noteTitle.textContent = note.title;
        const notePreview = document.createElement('div');
        notePreview.className = 'note-preview';
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = note.content;
        notePreview.textContent = tempDiv.textContent.substring(0, 50);
        noteContent.appendChild(noteTitle);
        noteContent.appendChild(notePreview);
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'delete-btn';
        deleteBtn.innerHTML = 'Ã—';
        deleteBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            showDeleteModal(note.id);
        });
        noteCard.appendChild(noteContent);
        noteCard.appendChild(deleteBtn);
        noteCard.addEventListener('click', () => {
            loadNote(note.id);
            if (window.innerWidth <= 768) {
                sidebar.classList.remove('visible');
                document.getElementById('main-content').classList.remove('sidebar-visible');
                toggleSidebar.innerHTML = 'â˜°';
            }
        });
        notesList.appendChild(noteCard);
    });
}

function showWelcomeScreen() {
    editorContainer.style.display = 'none';
    welcomeScreen.style.display = 'flex';
}

function hideWelcomeScreen() {
    editorContainer.style.display = 'flex';
    welcomeScreen.style.display = 'none';
}

function setFontSize(size) {
    document.execCommand('fontSize', false, size);
}

function setTextColor(color) {
    document.execCommand('foreColor', false, color);
}

function exportNotes() {
    try {
        const notesData = notes.map(note => ({
            title: note.title,
            content: note.content,
            created: note.created,
            updated: note.updated
        }));
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(notesData, null, 2));
        const downloadAnchorNode = document.createElement('a');
        downloadAnchorNode.setAttribute("href", dataStr);
        downloadAnchorNode.setAttribute("download", "secure-notes-export.json");
        document.body.appendChild(downloadAnchorNode);
        downloadAnchorNode.click();
        downloadAnchorNode.remove();
    } catch (e) {
        console.error('Error exporting notes:', e);
        showSystemMessage('Error exporting notes. Please try again.', 'error');
    }
}

init();
</script>
</body>
</html>
