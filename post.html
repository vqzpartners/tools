<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex">
    <title>Fast Text Video</title>
    
    <!-- Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;800&display=swap" rel="stylesheet">

    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>

    <style>
        * { box-sizing: border-box; }
        
        body {
            margin: 0;
            height: 100vh;
            display: flex;
            font-family: 'Inter', sans-serif;
            background: #111;
            color: #fff;
            overflow: hidden;
        }

        /* LEFT: Input Area */
        .editor-pane {
            flex: 1;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            background: #222;
            border-right: 1px solid #333;
        }

        textarea {
            width: 100%;
            flex: 1;
            background: #111;
            border: 1px solid #444;
            color: #fff;
            padding: 1.5rem;
            font-family: 'Inter', sans-serif;
            font-size: 1.1rem;
            line-height: 1.6;
            resize: none;
            border-radius: 8px;
            outline: none;
        }
        
        textarea:focus { border-color: #666; }

        .controls {
            display: flex;
            gap: 10px;
            height: 50px;
        }

        button {
            flex: 1;
            border: none;
            border-radius: 6px;
            font-weight: 800;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.2s;
            font-family: 'Inter', sans-serif;
        }

        .btn-theme { background: #444; color: #fff; }
        .btn-theme:hover { background: #555; }

        .btn-export { background: #fff; color: #000; }
        .btn-export:hover { opacity: 0.9; }
        .btn-export:disabled { background: #666; cursor: wait; }

        /* RIGHT: Preview Area */
        .preview-pane {
            flex: 1;
            background: #000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            position: relative;
        }

        /* The 3:4 Aspect Ratio Canvas (1080x1440 scaled down visually) */
        #canvas-wrapper {
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #render-target {
            width: 1080px;
            height: 1440px;
            /* Default Theme: Black */
            background-color: #000000;
            color: #ffffff;
            
            padding: 100px;
            display: flex;
            flex-direction: column;
            justify-content: center; /* Vertically Center text */
            
            /* Logic to scale this huge div to fit screen */
            transform-origin: center center;
            box-shadow: 0 0 50px rgba(0,0,0,0.5);
        }

        /* Text Styling inside Canvas */
        #markdown-output {
            font-size: 55px;
            line-height: 1.3;
            font-weight: 800;
            white-space: pre-wrap; /* Essential for markdown spacing */
            word-wrap: break-word;
        }

        /* Reset Markdown margins for cleaner look */
        #markdown-output p { margin: 0 0 0.8em 0; }
        #markdown-output h1, #markdown-output h2 { margin: 0 0 0.5em 0; }
        #markdown-output ul, #markdown-output ol { margin: 0 0 1em 1em; }
        
        /* Themes */
        .theme-white { background-color: #ffffff !important; color: #000000 !important; }
        
        /* Utility */
        #hidden-recorder { display: none; }
    </style>
</head>
<body>

    <!-- LEFT SIDE: Controls -->
    <div class="editor-pane">
        <h3 style="margin:0; opacity:0.7;">Insta Writer</h3>
        
        <textarea id="input-text" placeholder="Start typing here...
Line breaks will be preserved.
**Markdown** is supported.">hello this is line one

this is line two

this is line three

and also this is line four hahaha</textarea>

        <div class="controls">
            <button class="btn-theme" onclick="toggleTheme()">Toggle B/W</button>
            <button class="btn-export" id="export-btn" onclick="exportVideo()">Export Video (10s)</button>
        </div>
        <div id="status-msg" style="font-size:0.9rem; color:#888; text-align:center;"></div>
    </div>

    <!-- RIGHT SIDE: Preview -->
    <div class="preview-pane">
        <div id="canvas-wrapper">
            <div id="render-target">
                <div id="markdown-output"></div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. CONFIGURATION ---
        // Force simple line breaks (gfm: true, breaks: true)
        marked.setOptions({
            breaks: true, 
            gfm: true 
        });

        const input = document.getElementById('input-text');
        const output = document.getElementById('markdown-output');
        const target = document.getElementById('render-target');
        const wrapper = document.getElementById('canvas-wrapper');
        const btnExport = document.getElementById('export-btn');
        const status = document.getElementById('status-msg');

        // --- 2. LIVE RENDERING ---
        function render() {
            const raw = input.value;
            output.innerHTML = marked.parse(raw);
        }
        input.addEventListener('input', render);
        render(); // Init

        // --- 3. AUTO-SCALE PREVIEW ---
        // Keeps the 1080x1440 div visible within the right pane
        function resizePreview() {
            const margin = 40;
            const availableW = wrapper.clientWidth - margin;
            const availableH = wrapper.clientHeight - margin;
            const scale = Math.min(availableW / 1080, availableH / 1440);
            target.style.transform = `scale(${scale})`;
        }
        window.addEventListener('resize', resizePreview);
        setTimeout(resizePreview, 50);

        // --- 4. THEME TOGGLE ---
        let isBlack = true;
        function toggleTheme() {
            isBlack = !isBlack;
            if(isBlack) target.classList.remove('theme-white');
            else target.classList.add('theme-white');
        }

        // --- 5. EXPORT VIDEO LOGIC ---
        async function exportVideo() {
            btnExport.disabled = true;
            status.innerText = "Capturing Image...";
            
            // 1. Reset transform to get full 1080p resolution capture
            const oldTransform = target.style.transform;
            target.style.transform = 'none';
            // Move to body to ensure full visibility during capture
            const parent = target.parentElement;
            target.style.position = 'fixed';
            target.style.top = '0';
            target.style.left = '0';
            target.style.zIndex = '-9999'; 
            document.body.appendChild(target);

            try {
                // 2. HTML -> Canvas Image
                const canvas = await html2canvas(target, {
                    width: 1080,
                    height: 1440,
                    scale: 1, 
                    logging: false
                });

                // Put DOM back
                target.style.position = '';
                target.style.top = '';
                target.style.left = '';
                target.style.zIndex = '';
                target.style.transform = oldTransform;
                parent.appendChild(target);

                // 3. Setup Recording
                status.innerText = "Recording Video (10s)...";
                
                // Create a stream from the canvas
                // We use a low FPS (10) because it's a static image, makes processing faster
                const stream = canvas.captureStream(10); 
                const recorder = new MediaRecorder(stream, {
                    mimeType: 'video/webm;codecs=vp9'
                });

                const chunks = [];
                recorder.ondataavailable = e => chunks.push(e.data);
                
                recorder.onstop = () => {
                    status.innerText = "Downloading...";
                    const blob = new Blob(chunks, { type: 'video/webm' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `insta-text-${Date.now()}.webm`;
                    a.click();
                    
                    setTimeout(() => {
                        btnExport.disabled = false;
                        status.innerText = "";
                        URL.revokeObjectURL(url);
                    }, 2000);
                };

                // 4. Record loop
                recorder.start();
                
                // To keep the stream active, we must "paint" the canvas occasionally
                // strictly speaking captureStream() needs updates to send frames in some browsers
                const ctx = canvas.getContext('2d');
                const duration = 10000; 
                const startTime = Date.now();
                
                const interval = setInterval(() => {
                    // Just redraw the same image to force a frame
                    ctx.drawImage(canvas, 0, 0);
                    
                    const elapsed = Date.now() - startTime;
                    const timeLeft = Math.ceil((duration - elapsed) / 1000);
                    status.innerText = `Recording... ${timeLeft}s`;

                    if (elapsed >= duration) {
                        clearInterval(interval);
                        recorder.stop();
                    }
                }, 500); // Update twice a second is enough for static text

            } catch (err) {
                console.error(err);
                status.innerText = "Error.";
                btnExport.disabled = false;
                // Restore layout on error
                target.style.position = '';
                target.style.transform = oldTransform;
                parent.appendChild(target);
            }
        }
    </script>
</body>
</html>
