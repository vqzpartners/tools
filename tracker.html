<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SOVEREIGNS | Financial Tracker</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&family=Montserrat:wght@700&display=swap" rel="stylesheet">
    <link rel="icon" href="https://cdn.sovereigns.co/favicon.png">
    <style>
:root {
    --bg-dark: #121212;
    --sidebar-dark: #1e1e1e;
    --text-color: #e0e0e0;
    --accent-color: #569cd6;
    --card-bg: #252526;
    --button-bg: #333333;
    --border-color: #3e3e42;
    
    --income-color: #4ec9b0;
    --expense-gen: #ce9178;
    
    /* Category Colors */
    --cat-food: #ce9178;
    --cat-housing: #d16969;
    --cat-transport: #dcdcaa;
    --cat-util: #4fc1ff;
    --cat-health: #6a9955;
    --cat-other: #c586c0;
}

* { box-sizing: border-box; }

body {
    font-family: 'Roboto Mono', monospace;
    margin: 0; padding: 0;
    background-color: var(--bg-dark);
    color: var(--text-color);
    height: 100vh;
    display: flex;
    overflow: hidden;
}

/* Sidebar */
#sidebar {
    background-color: var(--sidebar-dark);
    width: 280px;
    height: 100vh;
    display: flex;
    flex-direction: column;
    border-right: 1px solid var(--border-color);
    overflow-y: auto;
    z-index: 20;
    transition: transform 0.3s ease;
}

#sidebar-header { padding: 25px 20px; border-bottom: 1px solid var(--border-color); }
.brand-title {
    font-family: 'Montserrat', sans-serif;
    font-weight: 700;
    font-size: 1.4rem;
    color: white;
    letter-spacing: 1px;
    margin: 0;
}

.nav-btn {
    background: transparent; border: none; color: #888;
    padding: 15px 25px; text-align: left; cursor: pointer;
    font-family: inherit; transition: 0.2s;
    border-left: 3px solid transparent;
    font-size: 0.9rem;
}
.nav-btn:hover { background-color: var(--button-bg); color: white; }
.nav-btn.active { 
    background-color: var(--button-bg); 
    color: var(--accent-color);
    border-left: 3px solid var(--accent-color);
}

.sidebar-section { padding: 20px; border-top: 1px solid var(--border-color); margin-top: auto; }
.sidebar-section h4 { margin: 0 0 15px 0; font-size: 0.75rem; color: #666; text-transform: uppercase; letter-spacing: 1px;}

/* Tax Toggles */
.tax-radio { display: flex; align-items: center; cursor: pointer; font-size: 0.8rem; color: #aaa; margin-bottom: 8px; }
.tax-radio input { margin-right: 10px; accent-color: var(--accent-color); }
.tax-radio:hover { color: white; }

#add-new-btn {
    background: linear-gradient(135deg, #007acc, #005a9e);
    color: white; border: none;
    padding: 14px; margin: 20px;
    border-radius: 4px; cursor: pointer;
    font-weight: bold; font-family: inherit;
    box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    transition: transform 0.1s;
}
#add-new-btn:hover { transform: translateY(-1px); }

/* Main Content */
#main-content {
    flex: 1; display: flex; flex-direction: column;
    overflow: hidden; position: relative;
}

#header {
    padding: 20px 30px;
    border-bottom: 1px solid var(--border-color);
    background: var(--bg-dark);
    display: flex; justify-content: space-between; align-items: center;
}

#content-area { flex: 1; overflow-y: auto; padding: 20px; }

/* Dashboard */
#summary-bar {
    display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
    gap: 15px; margin-bottom: 25px;
}
.summary-card {
    background: var(--card-bg); padding: 20px;
    border-radius: 6px; border: 1px solid var(--border-color);
}
.summary-card h3 { margin: 0 0 8px 0; font-size: 0.7rem; color: #888; text-transform: uppercase; }
.amount { font-size: 1.5rem; font-weight: bold; }
.text-inc { color: var(--income-color); }
.text-exp { color: var(--expense-gen); }
.text-bal { color: white; }
.text-tax { color: #d16969; }

/* Split View */
.split-view {
    display: grid; grid-template-columns: 1fr 1fr;
    gap: 20px; height: calc(100% - 130px);
}
.column-header {
    padding: 12px; background: var(--button-bg);
    border-radius: 4px 4px 0 0; font-weight: bold; font-size: 0.9rem;
    text-align: center; border: 1px solid var(--border-color); border-bottom: none;
}
.col-inc .column-header { color: var(--income-color); border-top: 3px solid var(--income-color); }
.col-exp .column-header { color: var(--expense-gen); border-top: 3px solid var(--expense-gen); }

.item-list {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 0 0 4px 4px;
    overflow-y: auto; height: 100%; padding: 10px;
}

.t-item {
    display: flex; justify-content: space-between; align-items: center;
    background: #2d2d30; padding: 12px; margin-bottom: 8px;
    border-radius: 4px; border-left: 3px solid #555;
    cursor: pointer; transition: background 0.2s;
}
.t-item:hover { background: #38383a; }

/* Category Colors */
.cat-inc { border-left-color: var(--income-color); }
.cat-housing { border-left-color: var(--cat-housing); }
.cat-food { border-left-color: var(--cat-food); }
.cat-transport { border-left-color: var(--cat-transport); }
.cat-util { border-left-color: var(--cat-util); }
.cat-health { border-left-color: var(--cat-health); }
.cat-other { border-left-color: var(--cat-other); }

.t-desc { font-weight: bold; font-size: 0.9rem; }
.t-meta { font-size: 0.75rem; color: #888; margin-top: 4px; }
.t-amt { font-weight: bold; text-align: right; }
.recur-tag { font-size: 0.65rem; background: #1e1e1e; padding: 2px 6px; border-radius: 10px; margin-left: 6px; color: #aaa; border: 1px solid #444; }

/* Calendar */
.cal-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
.cal-grid {
    display: grid; grid-template-columns: repeat(7, 1fr);
    gap: 4px;
}
.cal-head { text-align: center; color: #666; font-size: 0.8rem; padding: 10px 0; font-weight: bold; }
.cal-day {
    background: var(--card-bg); min-height: 120px;
    border: 1px solid var(--border-color); padding: 5px;
    display: flex; flex-direction: column; gap: 4px;
}
.cal-num { font-size: 0.8rem; color: #666; align-self: flex-end; margin-bottom: 5px; }
.cal-pill {
    font-size: 0.7rem; padding: 3px 6px; border-radius: 3px;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    color: #121212; font-weight: bold; cursor: pointer; opacity: 0.9;
}
.pill-inc { background-color: var(--income-color); }
.pill-housing { background-color: var(--cat-housing); color: white; }
.pill-food { background-color: var(--cat-food); }
.pill-transport { background-color: var(--cat-transport); }
.pill-util { background-color: var(--cat-util); }
.pill-health { background-color: var(--cat-health); color: white;}
.pill-other { background-color: var(--cat-other); }

.pill-ghost { opacity: 0.5; font-style: italic; } /* For auto-recurring items */

/* Projection */
.proj-container { max-width: 700px; margin: 0 auto; }
.proj-card { 
    background: var(--card-bg); padding: 30px; 
    border-radius: 8px; border: 1px solid var(--border-color); 
}
.proj-row { display: flex; justify-content: space-between; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid #333; }
.proj-row:last-child { border: none; }
.proj-total { background: #333; padding: 20px; border-radius: 6px; margin-top: 20px; text-align: center; }

/* Modals */
.modal-overlay {
    display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.85); z-index: 100;
    justify-content: center; align-items: center;
}
.modal-overlay.visible { display: flex; }
.modal-box {
    background: #252526; padding: 25px; border-radius: 8px;
    width: 450px; max-width: 90%; border: 1px solid #444;
    box-shadow: 0 10px 25px rgba(0,0,0,0.5);
}
.modal-title { margin-top: 0; color: white; font-family: 'Montserrat', sans-serif; }

.form-group { margin-bottom: 15px; }
.form-group label { display: block; color: #888; font-size: 0.8rem; margin-bottom: 5px; }
.form-control {
    width: 100%; padding: 12px; background: #1e1e1e;
    border: 1px solid #444; color: white; border-radius: 4px;
    font-family: inherit; font-size: 0.9rem;
}
.form-control:focus { outline: none; border-color: var(--accent-color); }

.btn-row { display: flex; justify-content: flex-end; gap: 10px; margin-top: 25px; }
.btn { padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; font-family: inherit; }
.btn-primary { background: var(--accent-color); color: white; }
.btn-danger { background: var(--cat-housing); color: white; }
.btn-sec { background: transparent; color: #aaa; }

/* Type Toggle */
.type-toggle { display: flex; background: #1e1e1e; padding: 4px; border-radius: 6px; margin-bottom: 20px; border: 1px solid #444; }
.type-opt { flex: 1; text-align: center; padding: 10px; cursor: pointer; border-radius: 4px; color: #666; transition: 0.2s; }
.type-opt.active-inc { background: var(--income-color); color: #121212; font-weight: bold; }
.type-opt.active-exp { background: var(--expense-gen); color: #121212; font-weight: bold; }

.hide { display: none !important; }
    </style>
</head>
<body>

    <div id="sidebar">
        <div id="sidebar-header">
            <h1 class="brand-title">SOVEREIGNS</h1>
        </div>
        <button id="add-new-btn">+ New Transaction</button>
        
        <button class="nav-btn active" onclick="switchTab('dashboard')">ðŸ“Š Dashboard</button>
        <button class="nav-btn" onclick="switchTab('calendar')">ðŸ“… Calendar</button>
        <button class="nav-btn" onclick="switchTab('projection')">ðŸ“ˆ Projections</button>
        
        <div class="sidebar-section">
            <h4>ðŸ‡µðŸ‡¦ Panama Tax</h4>
            <div class="tax-radio">
                <input type="radio" name="tax-mode" value="auto" checked onchange="updateUI()"> 
                <span id="tax-auto-label">Auto (Calculated)</span>
            </div>
            <div class="tax-radio">
                <input type="radio" name="tax-mode" value="low" onchange="updateUI()"> 
                <span>Under $11k (0%)</span>
            </div>
            <div class="tax-radio">
                <input type="radio" name="tax-mode" value="mid" onchange="updateUI()"> 
                <span>$11k - $50k (15%)</span>
            </div>
            <div class="tax-radio">
                <input type="radio" name="tax-mode" value="high" onchange="updateUI()"> 
                <span>Over $50k (25%)</span>
            </div>
        </div>

        <button class="nav-btn" onclick="checkSecurity()" style="margin-top: auto; border-top: 1px solid #333;">ðŸ”’ Data Security</button>
    </div>

    <div id="main-content">
        <div id="header">
            <h2 id="page-title" style="margin:0; font-size:1.1rem;">Dashboard</h2>
        </div>

        <div id="content-area">
            
            <!-- DASHBOARD -->
            <div id="view-dashboard">
                <div id="summary-bar">
                    <div class="summary-card">
                        <h3>Gross Income</h3>
                        <div class="amount text-inc" id="d-inc">$0</div>
                    </div>
                    <div class="summary-card">
                        <h3>Expenses</h3>
                        <div class="amount text-exp" id="d-exp">$0</div>
                    </div>
                    <div class="summary-card">
                        <h3>Est. Taxes</h3>
                        <div class="amount text-tax" id="d-tax">$0</div>
                    </div>
                    <div class="summary-card" style="background: #333;">
                        <h3>Net Balance</h3>
                        <div class="amount text-bal" id="d-bal">$0</div>
                    </div>
                </div>

                <div class="split-view">
                    <div class="col-inc">
                        <div class="column-header">INCOME</div>
                        <div id="list-inc" class="item-list"></div>
                    </div>
                    <div class="col-exp">
                        <div class="column-header">EXPENSES</div>
                        <div id="list-exp" class="item-list"></div>
                    </div>
                </div>
            </div>

            <!-- CALENDAR -->
            <div id="view-calendar" class="hide">
                <div class="cal-controls">
                    <button class="btn btn-sec" onclick="changeMonth(-1)">â—€ Previous</button>
                    <h2 id="cal-title" style="margin:0;"></h2>
                    <button class="btn btn-sec" onclick="changeMonth(1)">Next â–¶</button>
                </div>
                <div class="cal-grid" id="cal-grid"></div>
            </div>

            <!-- PROJECTION -->
            <div id="view-projection" class="hide">
                <div class="proj-container">
                    <div class="proj-card">
                        <h2 style="font-family:'Montserrat'; margin-top:0;">End of Year Forecast</h2>
                        <p style="color:#888; font-size:0.85rem; margin-bottom:20px;">
                            Projection assumes recurring items (Monthly/Yearly) continue until Dec 31st.
                        </p>
                        
                        <div class="proj-row">
                            <span>Current Gross Balance</span>
                            <span id="p-cur">$0.00</span>
                        </div>
                        <div class="proj-row">
                            <span>+ Future Monthly Income</span>
                            <span class="text-inc" id="p-fut-inc">$0.00</span>
                        </div>
                        <div class="proj-row">
                            <span>- Future Monthly Expenses</span>
                            <span class="text-exp" id="p-fut-exp">$0.00</span>
                        </div>
                        <div class="proj-row">
                            <span>+/- Yearly Adjustments</span>
                            <span id="p-year-adj">$0.00</span>
                        </div>

                        <div style="margin: 20px 0; border-top: 1px dashed #444;"></div>
                        
                        <div class="proj-row">
                            <strong>Est. Gross Annual</strong>
                            <strong id="p-gross">$0.00</strong>
                        </div>
                        
                        <h4 style="margin: 15px 0 10px 0; color: #d16969; font-size: 0.8rem;">DEDUCTIONS (PANAMA)</h4>
                        <div class="proj-row">
                            <span>Seguro Educativo (1.25%)</span>
                            <span class="text-tax" id="p-tax-edu">$0.00</span>
                        </div>
                        <div class="proj-row">
                            <span>Income Tax (ISR)</span>
                            <span class="text-tax" id="p-tax-isr">$0.00</span>
                        </div>

                        <div class="proj-total">
                            <span style="display:block; font-size:0.8rem; color:#aaa; margin-bottom:5px;">ESTIMATED NET (DEC 31)</span>
                            <span class="amount text-inc" id="p-net">$0.00</span>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- TRANSACTION MODAL -->
    <div id="modal-tx" class="modal-overlay">
        <div class="modal-box">
            <h3 class="modal-title" id="m-title">New Transaction</h3>
            <form id="tx-form">
                <input type="hidden" id="tx-id">
                <div class="type-toggle">
                    <div class="type-opt active-inc" id="opt-inc" onclick="setTxType('income')">Income</div>
                    <div class="type-opt" id="opt-exp" onclick="setTxType('expense')">Expense</div>
                </div>
                <input type="hidden" id="tx-type" value="income">

                <div class="form-group">
                    <label>Description</label>
                    <input type="text" id="tx-desc" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>Amount ($)</label>
                    <input type="number" id="tx-amt" step="0.01" class="form-control" required>
                </div>
                <div class="form-group">
                    <label>Category</label>
                    <select id="tx-cat" class="form-control"></select>
                </div>
                <div style="display:flex; gap:15px;">
                    <div class="form-group" style="flex:1">
                        <label>Frequency</label>
                        <select id="tx-freq" class="form-control">
                            <option value="one-time">One Time</option>
                            <option value="monthly">Monthly</option>
                            <option value="yearly">Yearly</option>
                        </select>
                    </div>
                    <div class="form-group" style="flex:1">
                        <label>Date</label>
                        <input type="date" id="tx-date" class="form-control" required>
                    </div>
                </div>

                <div class="btn-row">
                    <button type="button" class="btn btn-danger hide" id="btn-del">Delete</button>
                    <button type="button" class="btn btn-sec" onclick="closeModal('modal-tx')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ALERT MODAL -->
    <div id="modal-alert" class="modal-overlay">
        <div class="modal-box" style="width: 350px; text-align:center;">
            <h3 class="modal-title" id="alert-msg">Message</h3>
            <div class="btn-row" style="justify-content: center;">
                <button class="btn btn-primary" onclick="closeModal('modal-alert')">OK</button>
            </div>
        </div>
    </div>

    <!-- CONFIRM MODAL -->
    <div id="modal-confirm" class="modal-overlay">
        <div class="modal-box" style="width: 350px;">
            <h3 class="modal-title">Confirm Action</h3>
            <p id="confirm-msg" style="color:#ccc;">Are you sure?</p>
            <div class="btn-row">
                <button class="btn btn-sec" onclick="closeModal('modal-confirm')">Cancel</button>
                <button class="btn btn-primary" id="btn-confirm-yes">Confirm</button>
            </div>
        </div>
    </div>

    <!-- SECURITY MODAL -->
    <div id="modal-sec" class="modal-overlay">
        <div class="modal-box">
            <h3 class="modal-title">ðŸ”’ Encrypted Vault</h3>
            <p id="sec-desc" style="color:#aaa; font-size:0.9rem;">Enter password to access data.</p>
            <input type="password" id="sec-pass" class="form-control" placeholder="Master Password">
            <div class="btn-row">
                <button class="btn btn-sec" onclick="closeModal('modal-sec')">Cancel</button>
                <button class="btn btn-primary" id="btn-sec-action">Unlock</button>
            </div>
        </div>
    </div>

    <script>
        // --- CRYPTO UTILS (AES-GCM) ---
        const cryptoUtils = {
            async generateKey(password, salt) {
                const enc = new TextEncoder();
                const keyMaterial = await crypto.subtle.importKey("raw", enc.encode(password), {name: "PBKDF2"}, false, ["deriveKey"]);
                return crypto.subtle.deriveKey(
                    { name: "PBKDF2", salt: salt, iterations: 100000, hash: "SHA-256" },
                    keyMaterial, { name: "AES-GCM", length: 256 }, false, ["encrypt", "decrypt"]
                );
            },
            async encrypt(data, password) {
                const salt = crypto.getRandomValues(new Uint8Array(16));
                const iv = crypto.getRandomValues(new Uint8Array(12));
                const key = await this.generateKey(password, salt);
                const enc = new TextEncoder();
                const encrypted = await crypto.subtle.encrypt({ name: "AES-GCM", iv: iv }, key, enc.encode(JSON.stringify(data)));
                
                // Pack as JSON string with hex buffers
                return JSON.stringify({
                    s: Array.from(salt),
                    iv: Array.from(iv),
                    d: Array.from(new Uint8Array(encrypted))
                });
            },
            async decrypt(packedData, password) {
                try {
                    const obj = JSON.parse(packedData);
                    const salt = new Uint8Array(obj.s);
                    const iv = new Uint8Array(obj.iv);
                    const data = new Uint8Array(obj.d);
                    const key = await this.generateKey(password, salt);
                    const decrypted = await crypto.subtle.decrypt({ name: "AES-GCM", iv: iv }, key, data);
                    return JSON.parse(new TextDecoder().decode(decrypted));
                } catch(e) { throw new Error("Invalid Password"); }
            }
        };

        // --- APP STATE ---
        let expenses = [];
        let calDate = new Date();
        let sessionKey = null; // Stores password in memory only
        let isEncrypted = false;
        
        const CATS = {
            income: ['Salary', 'Business', 'Investments', 'Other'],
            expense: ['Housing', 'Food', 'Transport', 'Utilities', 'Health', 'Other']
        };

        // --- MODAL UTILS ---
        function showModal(id) { document.getElementById(id).classList.add('visible'); }
        function closeModal(id) { document.getElementById(id).classList.remove('visible'); }
        function customAlert(msg) {
            document.getElementById('alert-msg').innerText = msg;
            showModal('modal-alert');
        }
        function customConfirm(msg, callback) {
            document.getElementById('confirm-msg').innerText = msg;
            document.getElementById('btn-confirm-yes').onclick = () => {
                callback();
                closeModal('modal-confirm');
            };
            showModal('modal-confirm');
        }

        // --- CORE LOGIC ---
        document.addEventListener('DOMContentLoaded', () => {
            if(localStorage.getItem('sov_data_enc')) {
                isEncrypted = true;
                document.getElementById('sec-desc').innerText = "Data is encrypted. Enter password to decrypt.";
                document.getElementById('btn-sec-action').innerText = "Decrypt & Load";
                showModal('modal-sec');
            } else {
                const raw = localStorage.getItem('sov_data');
                if(raw) expenses = JSON.parse(raw);
                updateUI();
            }
            document.getElementById('tx-date').valueAsDate = new Date();
            setTxType('income');
        });

        // Security Handlers
        function checkSecurity() {
            document.getElementById('sec-pass').value = '';
            if(isEncrypted) {
                // If already encrypted and unlocked, maybe change password? 
                // For simplicity, just show info
                customAlert("Data is currently Encrypted and Unlocked.");
            } else {
                // Set up encryption
                document.getElementById('sec-desc').innerText = "Create a password to encrypt your data locally.";
                document.getElementById('btn-sec-action').innerText = "Encrypt Now";
                showModal('modal-sec');
            }
        }

        document.getElementById('btn-sec-action').onclick = async () => {
            const pass = document.getElementById('sec-pass').value;
            if(!pass) return;

            if(isEncrypted && !sessionKey) {
                // Decrypting on load
                try {
                    const raw = localStorage.getItem('sov_data_enc');
                    expenses = await cryptoUtils.decrypt(raw, pass);
                    sessionKey = pass;
                    updateUI();
                    closeModal('modal-sec');
                } catch(e) { customAlert("Incorrect Password"); }
            } else if (!isEncrypted) {
                // Encrypting
                sessionKey = pass;
                isEncrypted = true;
                await saveData();
                closeModal('modal-sec');
                customAlert("Data Encrypted Successfully");
            }
        };

        // --- UI UPDATES ---
        function switchTab(tab) {
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            ['dashboard','calendar','projection'].forEach(v => document.getElementById('view-'+v).classList.add('hide'));
            document.getElementById('view-'+tab).classList.remove('hide');
            if(tab === 'calendar') renderCalendar();
            if(tab === 'projection') renderProjection();
        }

        async function saveData() {
            if(isEncrypted && sessionKey) {
                const enc = await cryptoUtils.encrypt(expenses, sessionKey);
                localStorage.setItem('sov_data_enc', enc);
                localStorage.removeItem('sov_data');
            } else {
                localStorage.setItem('sov_data', JSON.stringify(expenses));
            }
        }

        function calculateTax(annualIncome) {
            // Panama Logic
            // Edu Insurance: 1.25% on gross
            const edu = annualIncome * 0.0125;
            
            // ISR
            let isr = 0;
            const radios = document.getElementsByName('tax-mode');
            let mode = 'auto';
            radios.forEach(r => { if(r.checked) mode = r.value; });

            if(mode === 'auto') {
                if(annualIncome > 50000) isr = 5850 + ((annualIncome - 50000) * 0.25);
                else if(annualIncome > 11000) isr = (annualIncome - 11000) * 0.15;
            } else if(mode === 'mid') {
                isr = Math.max(0, annualIncome - 11000) * 0.15;
            } else if(mode === 'high') {
                isr = 5850 + (Math.max(0, annualIncome - 50000) * 0.25);
            }
            return { edu, isr, total: edu + isr };
        }

        function updateUI() {
            const lInc = document.getElementById('list-inc');
            const lExp = document.getElementById('list-exp');
            lInc.innerHTML = ''; lExp.innerHTML = '';
            
            let sumInc = 0, sumExp = 0;
            
            // Calculate Projection for Tax Bracket
            const proj = getProjection();
            const tax = calculateTax(proj.gross);
            
            // Update Auto Label
            let bracketLabel = "0%";
            if(proj.gross > 50000) bracketLabel = "25% Bracket";
            else if(proj.gross > 11000) bracketLabel = "15% Bracket";
            document.getElementById('tax-auto-label').innerText = `Auto (${bracketLabel})`;

            // Sort & Render Lists
            expenses.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach(ex => {
                const el = document.createElement('div');
                const catClass = ex.type === 'income' ? 'cat-inc' : 'cat-' + (ex.category||'other').toLowerCase();
                el.className = `t-item ${catClass}`;
                el.onclick = () => editTx(ex.id);
                
                let recur = ex.frequency !== 'one-time' ? `<span class="recur-tag">${ex.frequency}</span>` : '';
                
                el.innerHTML = `
                    <div>
                        <div class="t-desc">${ex.description} ${recur}</div>
                        <div class="t-meta">${ex.date} â€¢ ${ex.category}</div>
                    </div>
                    <div class="t-amt">$${ex.amount.toFixed(2)}</div>
                `;
                
                if(ex.type === 'income') { sumInc += ex.amount; lInc.appendChild(el); }
                else { sumExp += ex.amount; lExp.appendChild(el); }
            });

            document.getElementById('d-inc').innerText = `$${sumInc.toFixed(2)}`;
            document.getElementById('d-exp').innerText = `$${sumExp.toFixed(2)}`;
            
            // Current Tax Estimation (YTD based on ratio)
            const effectiveRate = proj.gross > 0 ? (tax.total / proj.gross) : 0;
            const ytdTax = sumInc * effectiveRate;
            
            document.getElementById('d-tax').innerText = `-$${ytdTax.toFixed(2)}`;
            document.getElementById('d-bal').innerText = `$${(sumInc - sumExp - ytdTax).toFixed(2)}`;

            if(!document.getElementById('view-projection').classList.contains('hide')) renderProjection();
        }

        // --- PROJECTION ENGINE ---
        function getProjection() {
            const today = new Date();
            const monthIndex = today.getMonth(); 
            const remMonths = 11 - monthIndex;

            let curInc = 0, curExp = 0, moInc = 0, moExp = 0, yrAdj = 0;

            expenses.forEach(x => {
                if(x.type === 'income') curInc += x.amount; else curExp += x.amount;
                
                if(x.frequency === 'monthly') {
                    if(x.type === 'income') moInc += x.amount; else moExp += x.amount;
                }
                // Simplified Yearly: If it's yearly and hasn't happened yet this year?
                // For MVP, let's just assume yearly items add to the base projection once
                if(x.frequency === 'yearly') {
                    // Logic could be improved to check dates
                }
            });

            const futInc = moInc * remMonths;
            const futExp = moExp * remMonths;
            
            return {
                cur: curInc - curExp,
                futInc, futExp,
                gross: curInc + futInc + (yrAdj > 0 ? yrAdj : 0) // Gross annual for tax
            };
        }

        function renderProjection() {
            const d = getProjection();
            const tax = calculateTax(d.gross);

            document.getElementById('p-cur').innerText = `$${d.cur.toFixed(2)}`;
            document.getElementById('p-fut-inc').innerText = `+$${d.futInc.toFixed(2)}`;
            document.getElementById('p-fut-exp').innerText = `-$${d.futExp.toFixed(2)}`;
            document.getElementById('p-gross').innerText = `$${d.gross.toFixed(2)}`;
            
            document.getElementById('p-tax-edu').innerText = `-$${tax.edu.toFixed(2)}`;
            document.getElementById('p-tax-isr').innerText = `-$${tax.isr.toFixed(2)}`;
            
            const net = d.gross - (expenses.reduce((a,c)=>c.type==='expense'?a+c.amount:a, 0) + d.futExp) - tax.total;
            document.getElementById('p-net').innerText = `$${net.toFixed(2)}`;
        }

        // --- CALENDAR ENGINE (SMART PILLS) ---
        function changeMonth(d) { calDate.setMonth(calDate.getMonth()+d); renderCalendar(); }
        
        function renderCalendar() {
            const grid = document.getElementById('cal-grid');
            grid.innerHTML = '';
            
            const y = calDate.getFullYear();
            const m = calDate.getMonth();
            document.getElementById('cal-title').innerText = calDate.toLocaleDateString('en-US', {month:'long', year:'numeric'});

            ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].forEach(d=>grid.innerHTML+=`<div class="cal-head">${d}</div>`);
            
            const firstDay = new Date(y, m, 1).getDay();
            const daysInMonth = new Date(y, m+1, 0).getDate();

            for(let i=0; i<firstDay; i++) grid.innerHTML += `<div></div>`;

            for(let d=1; d<=daysInMonth; d++) {
                const cell = document.createElement('div');
                cell.className = 'cal-day';
                cell.innerHTML = `<span class="cal-num">${d}</span>`;
                
                const dayDate = new Date(y, m, d);
                
                // Smart Filter for Recurring
                const events = expenses.filter(x => {
                    const xDate = new Date(x.date + 'T00:00:00'); // Normalize
                    
                    if(xDate > dayDate) return false; // Hasn't started yet

                    if(x.frequency === 'one-time') {
                        return xDate.getDate() === d && xDate.getMonth() === m && xDate.getFullYear() === y;
                    }
                    if(x.frequency === 'monthly') {
                        return xDate.getDate() === d; // Falls on this day of month
                    }
                    if(x.frequency === 'yearly') {
                        return xDate.getDate() === d && xDate.getMonth() === m;
                    }
                    return false;
                });

                events.forEach(ev => {
                    const pill = document.createElement('div');
                    const isGhost = ev.frequency !== 'one-time' && (new Date(ev.date) < dayDate);
                    const colorClass = ev.type === 'income' ? 'pill-inc' : 'pill-' + (ev.category||'other').toLowerCase();
                    
                    pill.className = `cal-pill ${colorClass} ${isGhost ? 'pill-ghost' : ''}`;
                    pill.innerText = ev.description;
                    pill.onclick = () => editTx(ev.id);
                    cell.appendChild(pill);
                });

                grid.appendChild(cell);
            }
        }

        // --- FORM HANDLING ---
        document.getElementById('add-new-btn').onclick = () => {
            document.getElementById('tx-form').reset();
            document.getElementById('tx-id').value = '';
            document.getElementById('m-title').innerText = 'New Transaction';
            document.getElementById('btn-del').classList.add('hide');
            document.getElementById('tx-date').valueAsDate = new Date();
            setTxType('income');
            showModal('modal-tx');
        };

        function setTxType(t) {
            document.getElementById('tx-type').value = t;
            const sel = document.getElementById('tx-cat');
            sel.innerHTML = CATS[t].map(c=>`<option value="${c}">${c}</option>`).join('');
            
            if(t==='income') {
                document.getElementById('opt-inc').classList.add('active-inc');
                document.getElementById('opt-exp').classList.remove('active-exp');
            } else {
                document.getElementById('opt-inc').classList.remove('active-inc');
                document.getElementById('opt-exp').classList.add('active-exp');
            }
        }

        function editTx(id) {
            const tx = expenses.find(x => x.id === id);
            if(!tx) return;
            document.getElementById('tx-id').value = tx.id;
            document.getElementById('tx-desc').value = tx.description;
            document.getElementById('tx-amt').value = tx.amount;
            document.getElementById('tx-date').value = tx.date;
            document.getElementById('tx-freq').value = tx.frequency;
            setTxType(tx.type);
            document.getElementById('tx-cat').value = tx.category;
            
            document.getElementById('m-title').innerText = 'Edit Transaction';
            const delBtn = document.getElementById('btn-del');
            delBtn.classList.remove('hide');
            delBtn.onclick = () => {
                customConfirm("Delete this transaction?", async () => {
                    expenses = expenses.filter(e => e.id !== id);
                    await saveData();
                    updateUI();
                    closeModal('modal-tx');
                });
            };
            showModal('modal-tx');
        }

        document.getElementById('tx-form').onsubmit = async (e) => {
            e.preventDefault();
            const id = document.getElementById('tx-id').value;
            const item = {
                id: id || Date.now().toString(),
                type: document.getElementById('tx-type').value,
                description: document.getElementById('tx-desc').value,
                amount: parseFloat(document.getElementById('tx-amt').value),
                category: document.getElementById('tx-cat').value,
                frequency: document.getElementById('tx-freq').value,
                date: document.getElementById('tx-date').value
            };

            if(id) {
                const idx = expenses.findIndex(x => x.id === id);
                expenses[idx] = item;
            } else {
                expenses.push(item);
            }
            
            await saveData();
            updateUI();
            closeModal('modal-tx');
        };

    </script>
</body>
</html>
