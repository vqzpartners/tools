<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Expense Tracker</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
:root {
    --bg-dark: #1e1e1e;
    --sidebar-dark: #252526;
    --text-color: #e0e0e0;
    --accent-color: #569cd6;
    --card-bg: #2d2d2d;
    --button-bg: #3c3c3c;
    --button-hover: #4e4e4e;
    --delete-color: #ce4242;
    --delete-hover: #e05050;
    --income-color: #4ec9b0;
    --expense-color: #ce9178;
    --border-color: #444;
}

* {
    box-sizing: border-box;
}

body {
    font-family: 'Roboto Mono', monospace;
    margin: 0;
    padding: 0;
    background-color: var(--bg-dark);
    color: var(--text-color);
    height: 100vh;
    display: flex;
    overflow: hidden;
}

#sidebar {
    background-color: var(--sidebar-dark);
    width: 280px;
    height: 100vh;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    position: fixed;
    z-index: 10;
    transform: translateX(-280px);
    transition: transform 0.3s ease;
}

#sidebar.visible {
    transform: translateX(0);
}

#toggle-sidebar {
    position: fixed;
    left: 0;
    top: 50%;
    transform: translateY(-50%);
    background: var(--sidebar-dark);
    border: none;
    color: var(--text-color);
    width: 30px;
    height: 60px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    z-index: 20;
    border-radius: 0 4px 4px 0;
    box-shadow: 2px 0 5px rgba(0,0,0,0.2);
}

#toggle-sidebar:hover {
    background-color: var(--button-hover);
}

#sidebar-header {
    padding: 15px;
    border-bottom: 1px solid var(--border-color);
}

#main-content {
    flex: 1;
    display: flex;
    flex-direction: column;
    height: 100vh;
    margin-left: 30px;
    transition: margin-left 0.3s ease;
}

#main-content.sidebar-visible {
    margin-left: 280px;
}

#header {
    padding: 20px;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

#summary-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-bottom: 20px;
}

.summary-card {
    background: var(--card-bg);
    padding: 20px;
    border-radius: 8px;
    text-align: center;
    border: 1px solid var(--border-color);
}

.summary-card h3 {
    margin: 0 0 10px 0;
    font-size: 0.9rem;
    color: #a0a0a0;
}

.summary-card .amount {
    font-size: 1.8rem;
    font-weight: bold;
    margin: 0;
}

.income { color: var(--income-color); }
.expense { color: var(--expense-color); }
.balance { color: var(--accent-color); }

#add-expense-btn {
    background-color: var(--accent-color);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 4px;
    cursor: pointer;
    font-family: 'Roboto Mono', monospace;
    margin: 15px;
}

#add-expense-btn:hover {
    background-color: #4a88c7;
}

#content-area {
    flex: 1;
    padding: 20px;
    overflow-y: auto;
}

.expense-form {
    background: var(--card-bg);
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 20px;
    border: 1px solid var(--border-color);
}

.form-row {
    display: flex;
    gap: 15px;
    margin-bottom: 15px;
}

.form-group {
    flex: 1;
}

.form-group label {
    display: block;
    margin-bottom: 5px;
    color: #a0a0a0;
    font-size: 0.9rem;
}

.form-group input, .form-group select {
    width: 100%;
    padding: 8px;
    background-color: var(--bg-dark);
    border: 1px solid var(--border-color);
    border-radius: 4px;
    color: var(--text-color);
    font-family: 'Roboto Mono', monospace;
}

.form-group input:focus, .form-group select:focus {
    outline: none;
    border-color: var(--accent-color);
}

.form-buttons {
    display: flex;
    gap: 10px;
}

.btn {
    padding: 8px 16px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-family: 'Roboto Mono', monospace;
    transition: background-color 0.2s;
}

.btn-primary {
    background-color: var(--accent-color);
    color: white;
}

.btn-primary:hover {
    background-color: #4a88c7;
}

.btn-secondary {
    background-color: var(--button-bg);
    color: var(--text-color);
}

.btn-secondary:hover {
    background-color: var(--button-hover);
}

.btn-danger {
    background-color: var(--delete-color);
    color: white;
}

.btn-danger:hover {
    background-color: var(--delete-hover);
}

.expenses-list {
    background: var(--card-bg);
    border-radius: 8px;
    border: 1px solid var(--border-color);
}

.expense-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px;
    border-bottom: 1px solid var(--border-color);
}

.expense-item:last-child {
    border-bottom: none;
}

.expense-info {
    flex: 1;
}

.expense-description {
    font-weight: bold;
    margin-bottom: 5px;
}

.expense-meta {
    font-size: 0.8rem;
    color: #a0a0a0;
}

.expense-amount {
    font-size: 1.2rem;
    font-weight: bold;
    margin-right: 15px;
}

.expense-actions {
    display: flex;
    gap: 5px;
}

.icon-btn {
    background: none;
    border: none;
    color: var(--text-color);
    cursor: pointer;
    padding: 5px;
    border-radius: 4px;
    transition: background-color 0.2s;
}

.icon-btn:hover {
    background-color: var(--button-hover);
}

.icon-btn.delete:hover {
    background-color: var(--delete-color);
}

.filters {
    display: flex;
    gap: 15px;
    margin-bottom: 20px;
    flex-wrap: wrap;
}

.filter-group {
    display: flex;
    flex-direction: column;
    gap: 5px;
}

.filter-group label {
    font-size: 0.8rem;
    color: #a0a0a0;
}

.filter-group select, .filter-group input {
    padding: 6px;
    background-color: var(--bg-dark);
    border: 1px solid var(--border-color);
    border-radius: 4px;
    color: var(--text-color);
    font-family: 'Roboto Mono', monospace;
}

#footer {
    padding: 15px 20px;
    text-align: right;
    border-top: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.encryption-status {
    display: flex;
    align-items: center;
}

.status-indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    margin-right: 6px;
}

.status-secured {
    background-color: var(--income-color);
}

.status-unsecured {
    background-color: var(--expense-color);
}

.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7);
    z-index: 100;
    justify-content: center;
    align-items: center;
}

.modal-content {
    background-color: var(--card-bg);
    padding: 20px;
    border-radius: 8px;
    max-width: 400px;
    width: 80%;
    border: 1px solid var(--border-color);
}

.modal-title {
    margin-top: 0;
    color: var(--text-color);
}

.modal-buttons {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    margin-top: 20px;
}

.password-input {
    width: 100%;
    padding: 8px;
    margin-top: 10px;
    background-color: var(--bg-dark);
    border: 1px solid var(--border-color);
    border-radius: 4px;
    color: var(--text-color);
    font-family: 'Roboto Mono', monospace;
}

.system-message {
    background-color: rgba(0, 0, 0, 0.3);
    padding: 10px;
    margin: 10px 0;
    border-radius: 4px;
    font-size: 0.9rem;
    text-align: center;
    color: #f4c2c2;
}

.welcome-screen {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    height: 100%;
    text-align: center;
    padding: 20px;
}

.hide { display: none !important; }

@media screen and (max-width: 768px) {
    #sidebar {
        width: 100%;
        transform: translateX(-100%);
    }
    
    #main-content {
        margin-left: 30px;
    }
    
    #main-content.sidebar-visible {
        margin-left: 30px;
    }
    
    .form-row {
        flex-direction: column;
    }
    
    .filters {
        flex-direction: column;
    }
    
    #summary-cards {
        grid-template-columns: 1fr;
    }
    
    .expense-item {
        flex-direction: column;
        align-items: flex-start;
        gap: 10px;
    }
    
    .expense-actions {
        align-self: flex-end;
    }
}
    </style>
</head>
<body>
    <button id="toggle-sidebar">‚ò∞</button>

    <div id="sidebar">
        <div id="sidebar-header">
            <h2>üí∞ Expenses</h2>
        </div>
        <button id="add-expense-btn">+ Add Expense</button>
        
        <div style="padding: 15px;">
            <div id="summary-cards">
                <div class="summary-card">
                    <h3>Total Income</h3>
                    <p class="amount income" id="total-income">$0.00</p>
                </div>
                <div class="summary-card">
                    <h3>Total Expenses</h3>
                    <p class="amount expense" id="total-expenses">$0.00</p>
                </div>
                <div class="summary-card">
                    <h3>Balance</h3>
                    <p class="amount balance" id="balance">$0.00</p>
                </div>
            </div>
        </div>
    </div>

    <div id="main-content">
        <div id="header">
            <h1>Expense Tracker</h1>
        </div>

        <div id="content-area">
            <div id="welcome-screen" class="welcome-screen">
                <h2>Welcome to Secure Expense Tracker</h2>
                <p>Start tracking your expenses securely with encryption support.</p>
                <p>Click "Add Expense" to get started or set up encryption for maximum security.</p>
            </div>

            <div id="expense-form" class="expense-form hide">
                <h3 id="form-title">Add New Expense</h3>
                <form id="expense-form-element">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="description">Description</label>
                            <input type="text" id="description" name="description" required>
                        </div>
                        <div class="form-group">
                            <label for="amount">Amount ($)</label>
                            <input type="number" id="amount" name="amount" step="0.01" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="category">Category</label>
                            <select id="category" name="category" required>
                                <option value="">Select Category</option>
                                <option value="food">Food & Dining</option>
                                <option value="transport">Transportation</option>
                                <option value="shopping">Shopping</option>
                                <option value="entertainment">Entertainment</option>
                                <option value="bills">Bills & Utilities</option>
                                <option value="health">Health & Medical</option>
                                <option value="education">Education</option>
                                <option value="travel">Travel</option>
                                <option value="income">Income</option>
                                <option value="other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="date">Date</label>
                            <input type="date" id="date" name="date" required>
                        </div>
                    </div>
                    <div class="form-buttons">
                        <button type="submit" class="btn btn-primary" id="save-btn">Save Expense</button>
                        <button type="button" class="btn btn-secondary" id="cancel-btn">Cancel</button>
                    </div>
                </form>
            </div>

            <div id="expenses-section" class="hide">
                <div class="filters">
                    <div class="filter-group">
                        <label for="filter-category">Filter by Category</label>
                        <select id="filter-category">
                            <option value="">All Categories</option>
                            <option value="food">Food & Dining</option>
                            <option value="transport">Transportation</option>
                            <option value="shopping">Shopping</option>
                            <option value="entertainment">Entertainment</option>
                            <option value="bills">Bills & Utilities</option>
                            <option value="health">Health & Medical</option>
                            <option value="education">Education</option>
                            <option value="travel">Travel</option>
                            <option value="income">Income</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="filter-month">Filter by Month</label>
                        <input type="month" id="filter-month">
                    </div>
                </div>

                <div id="expenses-list" class="expenses-list">
                    <!-- Expenses will be rendered here -->
                </div>
            </div>
        </div>

        <div id="footer">
            <div class="encryption-status">
                <div id="status-indicator" class="status-indicator status-unsecured"></div>
                <span id="status-text">Unsecured</span>
            </div>
            <div>
                <button id="lock-btn" class="btn btn-secondary">üîí Set Password</button>
                <button id="export-btn" class="btn btn-secondary">Export Data</button>
            </div>
        </div>
    </div>

    <!-- Password Modal -->
    <div id="password-modal" class="modal">
        <div class="modal-content">
            <h2 class="modal-title">Set Encryption Password</h2>
            <p>Enter a password to encrypt your expense data (minimum 8 characters).</p>
            <input type="password" id="password-input" class="password-input" placeholder="Password">
            <input type="password" id="confirm-password-input" class="password-input" placeholder="Confirm Password">
            <div id="password-message" class="system-message" style="display: none;"></div>
            <div class="modal-buttons">
                <button id="cancel-password" class="btn btn-secondary">Cancel</button>
                <button id="confirm-password" class="btn btn-primary">Set Password</button>
            </div>
        </div>
    </div>

    <!-- Unlock Modal -->
    <div id="unlock-modal" class="modal">
        <div class="modal-content">
            <h2 class="modal-title">Unlock Expense Data</h2>
            <p>Enter your password to access your encrypted expense data.</p>
            <input type="password" id="unlock-password-input" class="password-input" placeholder="Password">
            <div id="unlock-message" class="system-message" style="display: none;"></div>
            <div class="modal-buttons">
                <button id="unlock-password" class="btn btn-primary">Unlock</button>
            </div>
        </div>
    </div>

    <!-- Delete Modal -->
    <div id="delete-modal" class="modal">
        <div class="modal-content">
            <h2 class="modal-title">Confirm Delete</h2>
            <p>Are you sure you want to delete this expense? This action cannot be undone.</p>
            <div class="modal-buttons">
                <button id="cancel-delete" class="btn btn-secondary">Cancel</button>
                <button id="confirm-delete" class="btn btn-danger">Delete</button>
            </div>
        </div>
    </div>

    <script>
        // Crypto utilities
        const cryptoUtils = {
            generateSalt: async function() {
                return window.crypto.getRandomValues(new Uint8Array(16));
            },
            str2ab: function(str) {
                const encoder = new TextEncoder();
                return encoder.encode(str);
            },
            ab2hex: function(buffer) {
                return Array.from(new Uint8Array(buffer))
                    .map(b => b.toString(16).padStart(2, '0'))
                    .join('');
            },
            hex2ab: function(hex) {
                const bytes = new Uint8Array(hex.length / 2);
                for (let i = 0; i < hex.length; i += 2) {
                    bytes[i/2] = parseInt(hex.substring(i, i + 2), 16);
                }
                return bytes;
            },
            deriveKey: async function(password, salt) {
                const keyMaterial = await window.crypto.subtle.importKey(
                    "raw",
                    this.str2ab(password),
                    { name: "PBKDF2" },
                    false,
                    ["deriveBits", "deriveKey"]
                );
                return window.crypto.subtle.deriveKey(
                    {
                        name: "PBKDF2",
                        salt: salt,
                        iterations: 100000,
                        hash: "SHA-256"
                    },
                    keyMaterial,
                    { name: "AES-GCM", length: 256 },
                    false,
                    ["encrypt", "decrypt"]
                );
            },
            encrypt: async function(data, password) {
                try {
                    const salt = await this.generateSalt();
                    const key = await this.deriveKey(password, salt);
                    const iv = window.crypto.getRandomValues(new Uint8Array(12));
                    const encryptedContent = await window.crypto.subtle.encrypt(
                        { name: "AES-GCM", iv: iv },
                        key,
                        this.str2ab(data)
                    );
                    return {
                        version: 1,
                        salt: this.ab2hex(salt),
                        iv: this.ab2hex(iv),
                        data: this.ab2hex(encryptedContent)
                    };
                } catch (e) {
                    console.error("Encryption failed:", e);
                    throw e;
                }
            },
            decrypt: async function(encryptedData, password) {
                try {
                    const { salt, iv, data } = encryptedData;
                    const saltBuffer = this.hex2ab(salt);
                    const ivBuffer = this.hex2ab(iv);
                    const dataBuffer = this.hex2ab(data);
                    const key = await this.deriveKey(password, saltBuffer);
                    const decryptedContent = await window.crypto.subtle.decrypt(
                        { name: "AES-GCM", iv: ivBuffer },
                        key,
                        dataBuffer
                    );
                    const decoder = new TextDecoder();
                    return decoder.decode(decryptedContent);
                } catch (e) {
                    console.error("Decryption failed:", e);
                    throw e;
                }
            }
        };

        // Password utilities
        async function storePasswordHash(password) {
            try {
                const encoder = new TextEncoder();
                const data = encoder.encode(password);
                const hashBuffer = await crypto.subtle.digest('SHA-256', data);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                localStorage.setItem('expensesMasterPasswordHash', hashHex);
            } catch (e) {
                console.error('Error hashing password:', e);
            }
        }

        async function verifyPassword(password) {
            try {
                const encoder = new TextEncoder();
                const data = encoder.encode(password);
                const hashBuffer = await crypto.subtle.digest('SHA-256', data);
                const hashArray = Array.from(new Uint8Array(hashBuffer));
                const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                return hashHex === localStorage.getItem('expensesMasterPasswordHash');
            } catch (e) {
                console.error('Error verifying password:', e);
                return false;
            }
        }

        // Global variables
        let expenses = [];
        let currentExpenseId = null;
        let expenseToDeleteId = null;
        let isEncrypted = false;
        let isEditing = false;
        let sessionPassword = null; // Holds password during session for re-encryption

        // DOM elements
        const sidebar = document.getElementById('sidebar');
        const toggleSidebar = document.getElementById('toggle-sidebar');
        const mainContent = document.getElementById('main-content');
        const addExpenseBtn = document.getElementById('add-expense-btn');
        const expenseForm = document.getElementById('expense-form');
        const expenseFormElement = document.getElementById('expense-form-element');
        const expensesSection = document.getElementById('expenses-section');
        const expensesList = document.getElementById('expenses-list');
        const welcomeScreen = document.getElementById('welcome-screen');
        const formTitle = document.getElementById('form-title');
        const cancelBtn = document.getElementById('cancel-btn');
        const filterCategory = document.getElementById('filter-category');
        const filterMonth = document.getElementById('filter-month');
        const lockBtn = document.getElementById('lock-btn');
        const exportBtn = document.getElementById('export-btn');
        const statusIndicator = document.getElementById('status-indicator');
        const statusText = document.getElementById('status-text');

        // Modal elements
        const passwordModal = document.getElementById('password-modal');
        const unlockModal = document.getElementById('unlock-modal');
        const deleteModal = document.getElementById('delete-modal');
        const passwordInput = document.getElementById('password-input');
        const confirmPasswordInput = document.getElementById('confirm-password-input');
        const passwordMessage = document.getElementById('password-message');
        const unlockPasswordInput = document.getElementById('unlock-password-input');
        const unlockMessage = document.getElementById('unlock-message');

        // Initialize app
        function init() {
            setupEventListeners();
            setTodayDate();
            
            if (localStorage.getItem('expensesMasterPasswordHash')) {
                isEncrypted = true;
                updateEncryptionStatus();
                showUnlockModal();
            } else {
                loadExpenses();
                if (expenses.length === 0) {
                    showWelcomeScreen();
                } else {
                    showExpensesList();
                }
            }
        }

        function setupEventListeners() {
            // Sidebar toggle
            toggleSidebar.addEventListener('click', () => {
                sidebar.classList.toggle('visible');
                mainContent.classList.toggle('sidebar-visible');
                toggleSidebar.innerHTML = sidebar.classList.contains('visible') ? '√ó' : '‚ò∞';
            });

            // Add expense button
            addExpenseBtn.addEventListener('click', showExpenseForm);

            // Form submission
            expenseFormElement.addEventListener('submit', saveExpense);
            cancelBtn.addEventListener('click', hideExpenseForm);

            // Filters
            filterCategory.addEventListener('change', filterAndRender);
            filterMonth.addEventListener('change', filterAndRender);

            // Footer buttons
            lockBtn.addEventListener('click', showPasswordModal);
            exportBtn.addEventListener('click', exportExpenses);

            // Modal buttons
            document.getElementById('confirm-password').addEventListener('click', setEncryptionPassword);
            document.getElementById('cancel-password').addEventListener('click', () => {
                passwordModal.style.display = 'none';
                clearPasswordInputs();
            });
            unlockPasswordInput.addEventListener('keyup', (e) => {
                if (e.key === 'Enter') unlockExpenses();
            });
            document.getElementById('unlock-password').addEventListener('click', unlockExpenses);
            document.getElementById('confirm-delete').addEventListener('click', confirmDeleteExpense);
            document.getElementById('cancel-delete').addEventListener('click', () => {
                deleteModal.style.display = 'none';
                expenseToDeleteId = null;
            });
        }

        function setTodayDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date').value = today;
        }

        function showWelcomeScreen() {
            welcomeScreen.classList.remove('hide');
            expenseForm.classList.add('hide');
            expensesSection.classList.add('hide');
        }

        function showExpenseForm() {
            welcomeScreen.classList.add('hide');
            expenseForm.classList.remove('hide');
            expensesSection.classList.add('hide');
            formTitle.textContent = isEditing ? 'Edit Expense' : 'Add New Expense';
            document.getElementById('save-btn').textContent = isEditing ? 'Update Expense' : 'Save Expense';
        }

        function hideExpenseForm() {
            expenseForm.classList.add('hide');
            if (expenses.length > 0) {
                showExpensesList();
            } else {
                showWelcomeScreen();
            }
            resetForm();
        }

        function showExpensesList() {
            welcomeScreen.classList.add('hide');
            expenseForm.classList.add('hide');
            expensesSection.classList.remove('hide');
            filterAndRender();
        }

        function resetForm() {
            expenseFormElement.reset();
            setTodayDate();
            currentExpenseId = null;
            isEditing = false;
        }

        function saveExpense(e) {
            e.preventDefault();
            
            const formData = new FormData(expenseFormElement);
            const expense = {
                id: currentExpenseId || Date.now().toString(),
                description: formData.get('description').trim(),
                amount: parseFloat(formData.get('amount')),
                category: formData.get('category'),
                date: formData.get('date'),
                created: currentExpenseId ? 
                    expenses.find(exp => exp.id === currentExpenseId).created : 
                    new Date().toISOString(),
                updated: new Date().toISOString()
            };

            if (isEditing) {
                const index = expenses.findIndex(exp => exp.id === currentExpenseId);
                expenses[index] = expense;
            } else {
                expenses.unshift(expense);
            }

            saveExpenses();
            hideExpenseForm();
        }

        function editExpense(id) {
            const expense = expenses.find(exp => exp.id === id);
            if (!expense) return;

            currentExpenseId = id;
            isEditing = true;
            
            document.getElementById('description').value = expense.description;
            document.getElementById('amount').value = expense.amount;
            document.getElementById('category').value = expense.category;
            document.getElementById('date').value = expense.date;
            
            showExpenseForm();
        }

        function deleteExpense(id) {
            expenseToDeleteId = id;
            deleteModal.style.display = 'flex';
        }

        function confirmDeleteExpense() {
            if (expenseToDeleteId) {
                expenses = expenses.filter(exp => exp.id !== expenseToDeleteId);
                saveExpenses();
                filterAndRender();
                if (expenses.length === 0) {
                    showWelcomeScreen();
                }
            }
            deleteModal.style.display = 'none';
            expenseToDeleteId = null;
        }

        async function saveExpenses() {
            if (isEncrypted) {
                if (!sessionPassword) {
                    alert("Error: Session is locked. Cannot save data.");
                    return;
                }
                try {
                    const encryptedData = await cryptoUtils.encrypt(JSON.stringify(expenses), sessionPassword);
                    localStorage.setItem('expensesDataEncrypted', JSON.stringify(encryptedData));
                    localStorage.removeItem('expensesData');
                } catch (e) {
                    console.error("Failed to save encrypted data:", e);
                    alert("Error saving encrypted data.");
                }
            } else {
                localStorage.setItem('expensesData', JSON.stringify(expenses));
            }
        }

        function loadExpenses() {
            const data = localStorage.getItem('expensesData');
            if (data) {
                try {
                    expenses = JSON.parse(data);
                } catch (e) {
                    console.error("Error parsing expenses data:", e);
                    expenses = [];
                }
            } else {
                expenses = [];
            }
        }

        function filterAndRender() {
            renderExpensesList();
            updateSummary();
        }

        function renderExpensesList() {
            const filteredExpenses = getFilteredExpenses();
            expensesList.innerHTML = ''; // Clear previous list

            if (filteredExpenses.length === 0) {
                expensesList.innerHTML = `<div class="expense-item"><p>No expenses found.</p></div>`;
                return;
            }

            filteredExpenses.forEach(expense => {
                const item = document.createElement('div');
                item.className = 'expense-item';
                item.dataset.id = expense.id;

                const isIncome = expense.category === 'income';
                const amountClass = isIncome ? 'income' : 'expense';
                const amountSign = isIncome ? '+' : '-';

                item.innerHTML = `
                    <div class="expense-info">
                        <div class="expense-description">${expense.description}</div>
                        <div class="expense-meta">${expense.category} on ${new Date(expense.date).toLocaleDateString()}</div>
                    </div>
                    <div class="expense-amount ${amountClass}">${amountSign}$${Math.abs(expense.amount).toFixed(2)}</div>
                    <div class="expense-actions">
                        <button class="icon-btn edit-btn" title="Edit">‚úèÔ∏è</button>
                        <button class="icon-btn delete-btn delete" title="Delete">üóëÔ∏è</button>
                    </div>
                `;

                item.querySelector('.edit-btn').addEventListener('click', () => editExpense(expense.id));
                item.querySelector('.delete-btn').addEventListener('click', () => deleteExpense(expense.id));

                expensesList.appendChild(item);
            });
        }

        function getFilteredExpenses() {
            let filtered = [...expenses];

            const category = filterCategory.value;
            if (category) {
                filtered = filtered.filter(exp => exp.category === category);
            }

            const month = filterMonth.value;
            if (month) {
                filtered = filtered.filter(exp => exp.date.startsWith(month));
            }
            
            filtered.sort((a, b) => new Date(b.date) - new Date(a.date));
            return filtered;
        }

        function updateSummary() {
            const summaryExpenses = getFilteredExpenses();
            
            const totalIncome = summaryExpenses
                .filter(exp => exp.category === 'income')
                .reduce((sum, exp) => sum + exp.amount, 0);

            const totalExpenses = summaryExpenses
                .filter(exp => exp.category !== 'income')
                .reduce((sum, exp) => sum + exp.amount, 0);

            const balance = totalIncome - totalExpenses;

            document.getElementById('total-income').textContent = `$${totalIncome.toFixed(2)}`;
            document.getElementById('total-expenses').textContent = `$${totalExpenses.toFixed(2)}`;
            document.getElementById('balance').textContent = `$${balance.toFixed(2)}`;
            
            const balanceEl = document.getElementById('balance');
            balanceEl.classList.remove('income', 'expense');
            balanceEl.classList.add(balance >= 0 ? 'income' : 'expense');
        }

        function updateEncryptionStatus() {
            if (isEncrypted) {
                statusIndicator.className = 'status-indicator status-secured';
                statusText.textContent = sessionPassword ? 'Secured & Unlocked' : 'Secured & Locked';
                lockBtn.textContent = 'Change Password';
            } else {
                statusIndicator.className = 'status-indicator status-unsecured';
                statusText.textContent = 'Unsecured';
                lockBtn.textContent = 'üîí Set Password';
            }
        }

        function showPasswordModal() {
            passwordModal.style.display = 'flex';
            passwordMessage.style.display = 'none';
            document.querySelector('#password-modal .modal-title').textContent = isEncrypted ? 'Change Encryption Password' : 'Set Encryption Password';
            passwordInput.placeholder = isEncrypted ? 'New Password' : 'Password';
        }
        
        function clearPasswordInputs() {
            passwordInput.value = '';
            confirmPasswordInput.value = '';
            passwordMessage.textContent = '';
            passwordMessage.style.display = 'none';
        }

        async function setEncryptionPassword() {
            const password = passwordInput.value;
            const confirmPassword = confirmPasswordInput.value;

            if (password.length < 8) {
                passwordMessage.textContent = "Password must be at least 8 characters.";
                passwordMessage.style.display = 'block';
                return;
            }
            if (password !== confirmPassword) {
                passwordMessage.textContent = "Passwords do not match.";
                passwordMessage.style.display = 'block';
                return;
            }

            try {
                const encryptedData = await cryptoUtils.encrypt(JSON.stringify(expenses), password);
                localStorage.setItem('expensesDataEncrypted', JSON.stringify(encryptedData));
                await storePasswordHash(password);
                localStorage.removeItem('expensesData');
                
                isEncrypted = true;
                sessionPassword = password;
                
                updateEncryptionStatus();
                passwordModal.style.display = 'none';
                clearPasswordInputs();
                alert("Password set and data encrypted successfully!");

            } catch(e) {
                console.error("Error setting password and encrypting:", e);
                passwordMessage.textContent = "An error occurred during encryption.";
                passwordMessage.style.display = 'block';
            }
        }

        function showUnlockModal() {
            unlockModal.style.display = 'flex';
            unlockPasswordInput.value = '';
            unlockMessage.style.display = 'none';
            unlockPasswordInput.focus();
            
            showWelcomeScreen(); // Hide content until unlocked
        }

        async function unlockExpenses() {
            const password = unlockPasswordInput.value;
            if (!password) return;

            const isValid = await verifyPassword(password);
            if (!isValid) {
                unlockMessage.textContent = "Incorrect password. Please try again.";
                unlockMessage.style.display = 'block';
                return;
            }
            
            try {
                const encryptedDataJSON = localStorage.getItem('expensesDataEncrypted');
                if (encryptedDataJSON) {
                    const encryptedData = JSON.parse(encryptedDataJSON);
                    const decryptedJSON = await cryptoUtils.decrypt(encryptedData, password);
                    expenses = JSON.parse(decryptedJSON);
                } else {
                    expenses = []; // No data to decrypt
                }
                
                sessionPassword = password;
                isEncrypted = true;
                
                unlockModal.style.display = 'none';
                unlockPasswordInput.value = '';
                
                updateEncryptionStatus();
                if (expenses.length > 0) {
                    showExpensesList();
                } else {
                    showWelcomeScreen();
                }

            } catch(e) {
                console.error("Decryption failed:", e);
                unlockMessage.textContent = "Decryption failed. Data might be corrupt or password is wrong.";
                unlockMessage.style.display = 'block';
            }
        }

        function exportExpenses() {
            if (expenses.length === 0) {
                alert("No expenses to export.");
                return;
            }

            const dataStr = JSON.stringify(expenses, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = `expenses_export_${new Date().toISOString().split('T')[0]}.json`;
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        // Start the application
        init();
    </script>
</body>
</html>
