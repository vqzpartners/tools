<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pro Expense Tracker - Panama Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
:root {
    --bg-dark: #1e1e1e;
    --sidebar-dark: #252526;
    --text-color: #e0e0e0;
    --accent-color: #569cd6;
    --card-bg: #2d2d2d;
    --button-bg: #3c3c3c;
    --button-hover: #4e4e4e;
    --income-color: #4ec9b0;
    --expense-color: #ce9178;
    --border-color: #444;
}

* { box-sizing: border-box; }

body {
    font-family: 'Roboto Mono', monospace;
    margin: 0; padding: 0;
    background-color: var(--bg-dark);
    color: var(--text-color);
    height: 100vh;
    display: flex;
    overflow: hidden;
}

/* Sidebar */
#sidebar {
    background-color: var(--sidebar-dark);
    width: 280px;
    height: 100vh;
    display: flex;
    flex-direction: column;
    border-right: 1px solid var(--border-color);
    padding-bottom: 20px;
    overflow-y: auto;
}

#sidebar-header { padding: 20px; border-bottom: 1px solid var(--border-color); margin-bottom: 10px; }
#sidebar-header h2 { margin: 0; font-size: 1.1rem; color: var(--accent-color); }

.nav-btn {
    background: transparent; border: none; color: #aaa;
    padding: 12px 20px; text-align: left; cursor: pointer;
    font-family: inherit; transition: 0.2s;
    border-left: 3px solid transparent;
}
.nav-btn:hover { background-color: var(--button-bg); color: white; }
.nav-btn.active { 
    background-color: var(--button-bg); 
    color: var(--accent-color);
    border-left: 3px solid var(--accent-color);
}

.sidebar-section { padding: 15px 20px; border-top: 1px solid #333; margin-top: 10px; }
.sidebar-section h4 { margin: 0 0 10px 0; font-size: 0.8rem; color: #666; text-transform: uppercase; }

/* Tax Toggles */
.tax-toggle-group { display: flex; flex-direction: column; gap: 8px; }
.tax-radio { display: flex; align-items: center; cursor: pointer; font-size: 0.85rem; color: #888; }
.tax-radio input { margin-right: 8px; }
.tax-radio:hover { color: white; }

#add-new-btn {
    background-color: var(--accent-color);
    color: white; border: none;
    padding: 12px; margin: 20px;
    border-radius: 4px; cursor: pointer;
    font-weight: bold; font-family: inherit;
}
#add-new-btn:hover { background-color: #4a88c7; }

/* Main Content */
#main-content {
    flex: 1; display: flex; flex-direction: column;
    overflow: hidden; position: relative;
}

#header {
    padding: 15px 30px;
    border-bottom: 1px solid var(--border-color);
    background: var(--bg-dark);
    display: flex; justify-content: space-between; align-items: center;
}

#content-area { flex: 1; overflow-y: auto; padding: 20px; }

/* Summary Cards */
#summary-bar {
    display: grid; grid-template-columns: repeat(4, 1fr);
    gap: 15px; margin-bottom: 25px;
}
.summary-card {
    background: var(--card-bg); padding: 15px;
    border-radius: 6px; border: 1px solid var(--border-color);
    text-align: center;
}
.summary-card h3 { margin: 0 0 5px 0; font-size: 0.75rem; color: #888; }
.amount { font-size: 1.4rem; font-weight: bold; }
.text-income { color: var(--income-color); }
.text-expense { color: var(--expense-color); }
.text-balance { color: var(--accent-color); }
.text-tax { color: #d6569c; }

/* Dual Columns */
.split-view {
    display: grid; grid-template-columns: 1fr 1fr;
    gap: 20px; height: calc(100% - 110px);
}
.column-header {
    padding: 10px; background: var(--button-bg);
    border-radius: 4px 4px 0 0; font-weight: bold;
    text-align: center; border: 1px solid var(--border-color); border-bottom: none;
}
.col-income .column-header { color: var(--income-color); border-top: 3px solid var(--income-color); }
.col-expense .column-header { color: var(--expense-color); border-top: 3px solid var(--expense-color); }

.item-list {
    background: var(--card-bg);
    border: 1px solid var(--border-color);
    border-radius: 0 0 4px 4px;
    overflow-y: auto; height: 100%; padding: 10px;
}

.transaction-item {
    display: flex; justify-content: space-between; align-items: center;
    background: var(--bg-dark); padding: 10px; margin-bottom: 8px;
    border-radius: 4px; border-left: 3px solid transparent;
    cursor: pointer; transition: background 0.2s;
}
.transaction-item:hover { background: #2a2a2a; }
.transaction-item.type-income { border-left-color: var(--income-color); }
.transaction-item.type-expense { border-left-color: var(--expense-color); }

.t-info h4 { margin: 0; font-size: 0.9rem; }
.t-meta { font-size: 0.7rem; color: #888; margin-top: 4px; }
.t-amounts { text-align: right; }
.t-gross { font-weight: bold; }
.t-net { font-size: 0.75rem; color: #d6569c; display: block; }
.recur-badge { font-size: 0.65rem; background: #333; padding: 2px 5px; border-radius: 3px; margin-left: 5px; color: #aaa; }

/* Calendar View */
.calendar-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
.calendar-grid {
    display: grid; grid-template-columns: repeat(7, 1fr);
    gap: 4px;
}
.cal-head { text-align: center; color: #888; font-size: 0.8rem; padding: 5px; }
.cal-day {
    background: var(--card-bg); min-height: 100px;
    border: 1px solid var(--border-color); padding: 4px;
    position: relative; display: flex; flex-direction: column; gap: 2px;
}
.cal-num { font-size: 0.75rem; color: #666; align-self: flex-end; margin-bottom: 2px; }
.cal-pill {
    font-size: 0.7rem; padding: 2px 4px; border-radius: 3px;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    color: #1e1e1e; font-weight: bold; cursor: pointer;
}
.pill-inc { background-color: var(--income-color); }
.pill-exp { background-color: var(--expense-color); }

/* Projection View */
.proj-container { max-width: 800px; margin: 0 auto; }
.proj-card { 
    background: var(--card-bg); padding: 25px; margin-bottom: 20px; 
    border-radius: 8px; border: 1px solid var(--border-color); 
}
.proj-row { display: flex; justify-content: space-between; margin-bottom: 10px; border-bottom: 1px solid #333; padding-bottom: 10px; }
.proj-row:last-child { border: none; }
.proj-highlight { background: #333; padding: 15px; border-radius: 6px; margin-top: 15px; text-align: center; }

/* Modal */
.modal {
    display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.8); z-index: 100;
    justify-content: center; align-items: center;
}
.modal.visible { display: flex; }
.modal-content {
    background: var(--card-bg); padding: 25px; border-radius: 8px;
    width: 450px; max-width: 90%; border: 1px solid var(--border-color);
}
.form-group { margin-bottom: 15px; }
.form-group label { display: block; color: #888; font-size: 0.8rem; margin-bottom: 5px; }
.form-input, .form-select {
    width: 100%; padding: 10px; background: var(--bg-dark);
    border: 1px solid var(--border-color); color: white; border-radius: 4px;
    font-family: inherit;
}
.type-toggle { display: flex; gap: 10px; margin-bottom: 15px; }
.type-btn {
    flex: 1; padding: 10px; border: 1px solid var(--border-color);
    background: var(--bg-dark); color: #888; cursor: pointer; text-align: center;
}
.type-btn.active.inc { background: var(--income-color); color: #1e1e1e; font-weight: bold; border-color: var(--income-color); }
.type-btn.active.exp { background: var(--expense-color); color: #1e1e1e; font-weight: bold; border-color: var(--expense-color); }

.hide { display: none !important; }

@media (max-width: 768px) {
    .split-view { grid-template-columns: 1fr; }
    #summary-bar { grid-template-columns: 1fr 1fr; }
    #sidebar { position: fixed; transform: translateX(-100%); z-index: 50; transition: transform 0.3s; }
    #sidebar.visible { transform: translateX(0); }
    #main-content { margin-left: 0; }
}
    </style>
</head>
<body>

    <!-- Sidebar -->
    <div id="sidebar">
        <div id="sidebar-header">
            <h2>üí∞ Panamanian Tracker</h2>
        </div>
        <button id="add-new-btn">+ Add Item</button>
        
        <button class="nav-btn active" onclick="switchTab('dashboard')">üìä Dashboard</button>
        <button class="nav-btn" onclick="switchTab('calendar')">üìÖ Calendar</button>
        <button class="nav-btn" onclick="switchTab('projection')">üìà Projection</button>
        
        <div class="sidebar-section">
            <h4>üáµüá¶ Tax Bracket (Toggle)</h4>
            <div class="tax-toggle-group">
                <label class="tax-radio">
                    <input type="radio" name="tax-mode" value="auto" checked onchange="updateTaxMode()"> 
                    Auto (Calculated)
                </label>
                <label class="tax-radio">
                    <input type="radio" name="tax-mode" value="low" onchange="updateTaxMode()"> 
                    Under $11k (0%)
                </label>
                <label class="tax-radio">
                    <input type="radio" name="tax-mode" value="mid" onchange="updateTaxMode()"> 
                    $11k - $50k (15%)
                </label>
                <label class="tax-radio">
                    <input type="radio" name="tax-mode" value="high" onchange="updateTaxMode()"> 
                    Over $50k (25%)
                </label>
            </div>
            <p style="font-size: 0.7rem; color: #666; margin-top: 10px;">
                Includes ISR &amp; Edu. Insurance (1.25%) for Professional Services.
            </p>
        </div>

        <div style="flex:1"></div>
        <button class="nav-btn" onclick="openLockModal()">üîí Security</button>
    </div>

    <!-- Main Content -->
    <div id="main-content">
        <div id="header">
            <h1 id="page-title" style="font-size: 1.2rem; margin:0;">Dashboard</h1>
            <button id="mobile-menu" style="background:none; border:none; color:white; font-size:1.5rem; cursor:pointer;" onclick="document.getElementById('sidebar').classList.toggle('visible')">‚ò∞</button>
        </div>

        <div id="content-area">
            
            <!-- DASHBOARD -->
            <div id="view-dashboard">
                <div id="summary-bar">
                    <div class="summary-card">
                        <h3>Gross Income</h3>
                        <div class="amount text-income" id="sum-inc">$0</div>
                    </div>
                    <div class="summary-card">
                        <h3>Expenses</h3>
                        <div class="amount text-expense" id="sum-exp">$0</div>
                    </div>
                    <div class="summary-card">
                        <h3>Est. Tax (PA)</h3>
                        <div class="amount text-tax" id="sum-tax">$0</div>
                    </div>
                    <div class="summary-card">
                        <h3>Net Balance</h3>
                        <div class="amount text-balance" id="sum-bal">$0</div>
                    </div>
                </div>

                <div class="split-view">
                    <div class="col-income">
                        <div class="column-header">INCOME</div>
                        <div id="list-income" class="item-list"></div>
                    </div>
                    <div class="col-expense">
                        <div class="column-header">EXPENSES</div>
                        <div id="list-expense" class="item-list"></div>
                    </div>
                </div>
            </div>

            <!-- CALENDAR -->
            <div id="view-calendar" class="hide">
                <div class="calendar-controls">
                    <button onclick="changeMonth(-1)" class="nav-btn">‚óÄ Prev</button>
                    <h2 id="cal-month-year" style="margin:0;"></h2>
                    <button onclick="changeMonth(1)" class="nav-btn">Next ‚ñ∂</button>
                </div>
                <div class="calendar-grid" id="calendar-grid"></div>
            </div>

            <!-- PROJECTION -->
            <div id="view-projection" class="hide">
                <div class="proj-container">
                    <div class="proj-card">
                        <h2 style="color: var(--accent-color);">End of Year Projection (Dec 31)</h2>
                        <p style="font-size:0.8rem; color:#888;">Based on Monthly recurring items & Year-to-Date totals.</p>
                        
                        <div class="proj-row">
                            <span>Current Gross Balance</span>
                            <span id="proj-current-bal">$0.00</span>
                        </div>
                        <div class="proj-row">
                            <span>+ Projected Monthly Income (Remaining Months)</span>
                            <span class="text-income" id="proj-future-inc">$0.00</span>
                        </div>
                        <div class="proj-row">
                            <span>- Projected Monthly Expenses (Remaining Months)</span>
                            <span class="text-expense" id="proj-future-exp">$0.00</span>
                        </div>
                        <div class="proj-row">
                            <span>+ Expected Yearly Items</span>
                            <span id="proj-yearly-adj">$0.00</span>
                        </div>

                        <hr style="border-color:#444;">
                        
                        <div class="proj-row" style="margin-top:10px;">
                            <span style="font-weight:bold;">Projected Annual Gross</span>
                            <span style="font-weight:bold;" id="proj-gross-total">$0.00</span>
                        </div>
                        <div class="proj-row">
                            <span style="color: #d6569c;">- Estimated Panama Tax (ISR + Edu)</span>
                            <span style="color: #d6569c;" id="proj-tax-total">$0.00</span>
                        </div>

                        <div class="proj-highlight">
                            <small>Estimated Net Balance on Dec 31st</small>
                            <div class="amount text-balance" id="proj-final-net">$0.00</div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Edit/Add Modal -->
    <div id="transaction-modal" class="modal">
        <div class="modal-content">
            <h2 id="modal-title">Edit Item</h2>
            <form id="t-form">
                <input type="hidden" id="edit-id" name="id">
                <div class="type-toggle">
                    <div class="type-btn active inc" id="btn-type-income" onclick="setFormType('income')">Income</div>
                    <div class="type-btn" id="btn-type-expense" onclick="setFormType('expense')">Expense</div>
                </div>
                <input type="hidden" name="type" id="form-type" value="income">

                <div class="form-group">
                    <label>Description</label>
                    <input type="text" name="description" id="f-desc" class="form-input" required>
                </div>
                <div class="form-group">
                    <label>Amount ($)</label>
                    <input type="number" name="amount" id="f-amount" step="0.01" class="form-input" required>
                </div>
                <div class="form-group">
                    <label>Frequency</label>
                    <select name="frequency" id="f-freq" class="form-select">
                        <option value="one-time">One Time</option>
                        <option value="monthly">Monthly (Recurring)</option>
                        <option value="yearly">Yearly (Recurring)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Date</label>
                    <input type="date" name="date" id="f-date" class="form-input" required>
                </div>
                
                <div style="display: flex; justify-content: space-between; margin-top: 25px;">
                    <button type="button" id="btn-delete" class="hide" style="color: var(--delete-color); background:none; border:none; cursor:pointer;">üóë Delete</button>
                    <div>
                        <button type="button" onclick="closeModal()" style="color:#aaa; background:none; border:none; margin-right:15px; cursor:pointer;">Cancel</button>
                        <button type="submit" style="background: var(--accent-color); color:white; border:none; padding:10px 20px; border-radius:4px; cursor:pointer;">Save Item</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Security Modal -->
    <div id="password-modal" class="modal">
        <div class="modal-content">
            <h2>üîê Security</h2>
            <p style="font-size:0.9rem; color:#aaa;">Encrypt your financial data locally.</p>
            <input type="password" id="secure-pass" class="form-input" placeholder="Enter Password">
            <div style="margin-top:15px; text-align:right;">
                <button onclick="closePassModal()" style="background:none; border:none; color:#aaa; cursor:pointer; margin-right:10px;">Close</button>
                <button id="btn-auth-action" style="background:var(--income-color); color:#1e1e1e; font-weight:bold; border:none; padding:10px 20px; border-radius:4px; cursor:pointer;">Unlock</button>
            </div>
        </div>
    </div>

    <script>
        // State
        let transactions = [];
        let calendarDate = new Date();
        let currentTaxMode = 'auto'; // 'auto', 'low', 'mid', 'high'
        let isEncrypted = false;

        // Constants for Panama Tax
        const TAX_BRACKETS = {
            low: { limit: 11000, rate: 0, base: 0 },
            mid: { limit: 50000, rate: 0.15, base: 0 }, // 15% on excess of 11k
            high: { limit: Infinity, rate: 0.25, base: 5850 } // 5850 + 25% on excess of 50k
        };
        const EDU_INSURANCE_RATE = 0.0125; // 1.25%

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            document.getElementById('f-date').valueAsDate = new Date();
            setFormType('income');
            updateUI();
        });

        // --- Core Logic ---
        function calculatePanamaTax(annualIncome) {
            // Educational Insurance (1.25% on gross)
            let eduTax = annualIncome * EDU_INSURANCE_RATE;
            let isrTax = 0;

            // Income Tax (ISR) Logic
            if (currentTaxMode === 'auto') {
                if (annualIncome <= 11000) {
                    isrTax = 0;
                } else if (annualIncome <= 50000) {
                    isrTax = (annualIncome - 11000) * 0.15;
                } else {
                    // Over 50k
                    isrTax = 5850 + ((annualIncome - 50000) * 0.25);
                }
            } else if (currentTaxMode === 'low') {
                isrTax = 0; // Force 0 tax view
            } else if (currentTaxMode === 'mid') {
                // Force 15% view on everything > 0 for simplicity? 
                // Or force the 11k-50k logic? Let's force the logic assuming they are in that bracket.
                // To be strictly a "toggle", let's apply a flat 15% on taxable base > 11k
                let taxable = Math.max(0, annualIncome - 11000);
                isrTax = taxable * 0.15;
            } else if (currentTaxMode === 'high') {
                // Force >50k logic
                let taxableBase = Math.max(0, annualIncome - 50000);
                isrTax = 5850 + (taxableBase * 0.25);
            }

            return { isr: isrTax, edu: eduTax, total: isrTax + eduTax };
        }

        // --- Navigation ---
        window.switchTab = (tab) => {
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            
            ['dashboard', 'calendar', 'projection'].forEach(v => {
                document.getElementById('view-' + v).classList.add('hide');
            });
            document.getElementById('view-' + tab).classList.remove('hide');

            if(tab === 'calendar') renderCalendar();
            if(tab === 'projection') renderProjection();
        };

        window.updateTaxMode = () => {
            const radios = document.getElementsByName('tax-mode');
            radios.forEach(r => { if(r.checked) currentTaxMode = r.value; });
            updateUI(); // Re-render with new tax calcs
        };

        // --- UI Rendering ---
        function updateUI() {
            renderDashboard();
            // If in other tabs, refresh them too
            if(!document.getElementById('view-projection').classList.contains('hide')) renderProjection();
            if(!document.getElementById('view-calendar').classList.contains('hide')) renderCalendar();
        }

        function renderDashboard() {
            const listInc = document.getElementById('list-income');
            const listExp = document.getElementById('list-expense');
            listInc.innerHTML = ''; listExp.innerHTML = '';

            let totalInc = 0;
            let totalExp = 0;

            // 1. Calculate projected annual income first to determine effective tax rate for "Auto" mode
            const { projectedAnnual } = calculateProjectionData();
            const taxInfo = calculatePanamaTax(projectedAnnual);
            
            // Effective tax rate for visual deduction in list view
            // (Tax / AnnualIncome) -> Apply this % to each item to show "Net"
            let effectiveTaxRate = projectedAnnual > 0 ? (taxInfo.total / projectedAnnual) : 0;

            // Sort Date Desc
            const sorted = [...transactions].sort((a,b) => new Date(b.date) - new Date(a.date));

            sorted.forEach(item => {
                const el = document.createElement('div');
                el.className = `transaction-item type-${item.type}`;
                el.onclick = () => openEditModal(item.id);

                const badge = item.frequency !== 'one-time' ? `<span class="recur-badge">${item.frequency}</span>` : '';
                
                let html = `
                    <div class="t-info">
                        <h4>${item.description} ${badge}</h4>
                        <div class="t-meta">${item.date}</div>
                    </div>
                    <div class="t-amounts">
                        <div class="t-gross">$${item.amount.toFixed(2)}</div>
                `;

                // If income, show Net after tax
                if(item.type === 'income') {
                    totalInc += item.amount;
                    const taxDed = item.amount * effectiveTaxRate;
                    const net = item.amount - taxDed;
                    if(taxDed > 0) {
                        html += `<span class="t-net">Net: $${net.toFixed(2)}</span>`;
                    }
                } else {
                    totalExp += item.amount;
                }

                html += `</div>`;
                el.innerHTML = html;

                if(item.type === 'income') listInc.appendChild(el);
                else listExp.appendChild(el);
            });

            // Update Summary Cards
            // We calculate tax on the CURRENT total income for the summary card context
            // Or should we show Year End Tax? Let's show Estimated Tax Year-to-Date
            const ytdTax = totalInc * effectiveTaxRate;

            document.getElementById('sum-inc').innerText = `$${totalInc.toFixed(2)}`;
            document.getElementById('sum-exp').innerText = `$${totalExp.toFixed(2)}`;
            document.getElementById('sum-tax').innerText = `-$${ytdTax.toFixed(2)}`;
            document.getElementById('sum-bal').innerText = `$${(totalInc - totalExp - ytdTax).toFixed(2)}`;
        }

        // --- Projection Logic ---
        function calculateProjectionData() {
            const today = new Date();
            const currentMonth = today.getMonth(); // 0-11
            const remainingMonths = 11 - currentMonth;

            // Current totals
            let curInc = 0, curExp = 0;
            // Monthly recurring totals
            let monthlyInc = 0, monthlyExp = 0;
            // Yearly items pending (Simple check: if item month > current month)
            let pendingYearlyInc = 0; // Not fully implemented for specific dates, using average for now
            
            transactions.forEach(t => {
                if(t.type === 'income') curInc += t.amount;
                else curExp += t.amount;

                if(t.frequency === 'monthly') {
                    if(t.type === 'income') monthlyInc += t.amount;
                    else monthlyExp += t.amount;
                }
            });

            // Projection Math
            const futureInc = monthlyInc * remainingMonths;
            const futureExp = monthlyExp * remainingMonths;
            const projectedAnnual = curInc + futureInc; 

            return { curInc, curExp, futureInc, futureExp, projectedAnnual };
        }

        function renderProjection() {
            const data = calculateProjectionData();
            const tax = calculatePanamaTax(data.projectedAnnual);

            document.getElementById('proj-current-bal').innerText = `$${(data.curInc - data.curExp).toFixed(2)}`;
            document.getElementById('proj-future-inc').innerText = `+$${data.futureInc.toFixed(2)}`;
            document.getElementById('proj-future-exp').innerText = `-$${data.futureExp.toFixed(2)}`;
            
            document.getElementById('proj-gross-total').innerText = `$${data.projectedAnnual.toFixed(2)}`;
            document.getElementById('proj-tax-total').innerText = `-$${tax.total.toFixed(2)}`;

            const finalNet = (data.projectedAnnual - tax.total) - (data.curExp + data.futureExp);
            document.getElementById('proj-final-net').innerText = `$${finalNet.toFixed(2)}`;
        }

        // --- Calendar Logic ---
        window.changeMonth = (delta) => {
            calendarDate.setMonth(calendarDate.getMonth() + delta);
            renderCalendar();
        };

        function renderCalendar() {
            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = '';
            
            const year = calendarDate.getFullYear();
            const month = calendarDate.getMonth();
            
            document.getElementById('cal-month-year').innerText = 
                calendarDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });

            // Headers
            ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].forEach(d => {
                const h = document.createElement('div');
                h.className = 'cal-head'; h.innerText = d;
                grid.appendChild(h);
            });

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            // Padding
            for(let i=0; i<firstDay; i++) grid.appendChild(document.createElement('div'));

            // Days
            for(let i=1; i<=daysInMonth; i++) {
                const dayEl = document.createElement('div');
                dayEl.className = 'cal-day';
                
                const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(i).padStart(2,'0')}`;
                
                dayEl.innerHTML = `<span class="cal-num">${i}</span>`;
                
                // Find items
                const daysItems = transactions.filter(t => t.date === dateStr);
                daysItems.forEach(t => {
                    const pill = document.createElement('div');
                    pill.className = `cal-pill pill-${t.type.substring(0,3)}`;
                    pill.innerText = t.description;
                    pill.title = `${t.description}: $${t.amount}`;
                    pill.onclick = (e) => { e.stopPropagation(); openEditModal(t.id); };
                    dayEl.appendChild(pill);
                });

                grid.appendChild(dayEl);
            }
        }

        // --- Form & Modal ---
        const modal = document.getElementById('transaction-modal');
        const form = document.getElementById('t-form');
        
        document.getElementById('add-new-btn').onclick = () => {
            form.reset();
            document.getElementById('edit-id').value = '';
            document.getElementById('modal-title').innerText = 'New Transaction';
            document.getElementById('btn-delete').classList.add('hide');
            document.getElementById('f-date').valueAsDate = new Date();
            setFormType('income');
            modal.classList.add('visible');
        };

        window.openEditModal = (id) => {
            const item = transactions.find(t => t.id === id);
            if(!item) return;

            document.getElementById('edit-id').value = item.id;
            document.getElementById('modal-title').innerText = 'Edit Transaction';
            document.getElementById('f-desc').value = item.description;
            document.getElementById('f-amount').value = item.amount;
            document.getElementById('f-freq').value = item.frequency;
            document.getElementById('f-date').value = item.date;
            
            setFormType(item.type);
            document.getElementById('btn-delete').classList.remove('hide');
            document.getElementById('btn-delete').onclick = () => deleteItem(id);
            
            modal.classList.add('visible');
        };

        window.closeModal = () => modal.classList.remove('visible');

        window.setFormType = (type) => {
            document.getElementById('form-type').value = type;
            if(type === 'income') {
                document.getElementById('btn-type-income').classList.add('active');
                document.getElementById('btn-type-expense').classList.remove('active');
            } else {
                document.getElementById('btn-type-income').classList.remove('active');
                document.getElementById('btn-type-expense').classList.add('active');
            }
        };

        form.onsubmit = (e) => {
            e.preventDefault();
            const formData = new FormData(form);
            const id = formData.get('id');
            
            const newItem = {
                id: id || Date.now().toString(),
                type: formData.get('type'),
                description: formData.get('description'),
                amount: parseFloat(formData.get('amount')),
                frequency: formData.get('frequency'),
                date: formData.get('date')
            };

            if(id) {
                const index = transactions.findIndex(t => t.id === id);
                transactions[index] = newItem;
            } else {
                transactions.push(newItem);
            }

            saveData();
            closeModal();
            updateUI();
        };

        function deleteItem(id) {
            if(confirm("Are you sure?")) {
                transactions = transactions.filter(t => t.id !== id);
                saveData();
                closeModal();
                updateUI();
            }
        }

        // --- Data Persistence ---
        function saveData() {
            localStorage.setItem('panamaExpenseData', JSON.stringify(transactions));
        }
        function loadData() {
            const data = localStorage.getItem('panamaExpenseData');
            if(data) transactions = JSON.parse(data);
        }

        // Security (Simplified for Demo)
        window.openLockModal = () => document.getElementById('password-modal').classList.add('visible');
        window.closePassModal = () => document.getElementById('password-modal').classList.remove('visible');
        
        // This is a placeholder for actual encryption
        document.getElementById('btn-auth-action').onclick = () => {
            alert('Security feature placeholder. In production this would decrypt data using AES-GCM.');
            closePassModal();
        };

    </script>
</body>
</html>
